<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="hbxywdk,hbxywdk@gmail.com"><title>å­¦ä¹ Vueæºç 9-æµ…è°ˆVueä¸­çš„Diffç®—æ³• Â· DK'S BLOG</title><meta name="description" content="è™šæ‹ŸDOMæ“ä½œDOMçš„ä»£ä»·æ“ä½œDOMçš„ä»£ä»·å¾ˆé«˜ï¼Œå½±å“é¡µé¢æ€§èƒ½çš„ä¸»è¦é—®é¢˜æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

è®¿é—®å’Œä¿®æ”¹DOMå…ƒç´ 
ä¿®æ”¹DOMå…ƒç´ çš„æ ·å¼ï¼Œå¯¼è‡´é‡ç»˜æˆ–é‡æ’
é€šè¿‡å¯¹DOMå…ƒç´ çš„äº‹ä»¶å¤„ç†ï¼Œå®Œæˆä¸ç”¨æˆ·çš„äº¤äº’åŠŸèƒ½

DOMçš„ä¿®æ”¹ä¼šå¯¼è‡´é‡ç»˜æˆ–é‡æ’

é‡ç»˜ï¼šé‡ç»˜æ˜¯æŒ‡ä¸€äº›æ ·å¼çš„ä¿®æ”¹ï¼Œå…ƒç´ çš„ä½ç½®å’Œå¤§å°éƒ½æ²¡æœ‰æ”¹å˜ï¼Œæµè§ˆå™¨ä¼šæ ¹æ®"><meta name="keywords" content="blog,FE,HTML,CSS,Javascript,Vue,Nuxt"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">DK'S BLOG</a></h3><div class="description"><p>Judge not from appearances.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/DKWang8"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/3136805851"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/hbxywdk"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">é¦–é¡µ</a></li><li><a href="/archives">å½’æ¡£</a></li><li><a href="/about">å…³äº</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/de.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>å­¦ä¹ Vueæºç 9-æµ…è°ˆVueä¸­çš„Diffç®—æ³•</a></h3></div><div class="post-content"><h3 id="è™šæ‹ŸDOM"><a href="#è™šæ‹ŸDOM" class="headerlink" title="è™šæ‹ŸDOM"></a>è™šæ‹ŸDOM</h3><h4 id="æ“ä½œDOMçš„ä»£ä»·"><a href="#æ“ä½œDOMçš„ä»£ä»·" class="headerlink" title="æ“ä½œDOMçš„ä»£ä»·"></a>æ“ä½œDOMçš„ä»£ä»·</h4><p><code>æ“ä½œDOMçš„ä»£ä»·å¾ˆé«˜</code>ï¼Œå½±å“é¡µé¢æ€§èƒ½çš„ä¸»è¦é—®é¢˜æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>è®¿é—®å’Œä¿®æ”¹DOMå…ƒç´ </li>
<li>ä¿®æ”¹DOMå…ƒç´ çš„æ ·å¼ï¼Œå¯¼è‡´<code>é‡ç»˜</code>æˆ–<code>é‡æ’</code></li>
<li>é€šè¿‡å¯¹DOMå…ƒç´ çš„äº‹ä»¶å¤„ç†ï¼Œå®Œæˆä¸ç”¨æˆ·çš„äº¤äº’åŠŸèƒ½</li>
</ul>
<p><code>DOMçš„ä¿®æ”¹ä¼šå¯¼è‡´é‡ç»˜æˆ–é‡æ’</code></p>
<ul>
<li>é‡ç»˜ï¼šé‡ç»˜æ˜¯æŒ‡ä¸€äº›æ ·å¼çš„ä¿®æ”¹ï¼Œå…ƒç´ çš„ä½ç½®å’Œå¤§å°éƒ½æ²¡æœ‰æ”¹å˜ï¼Œæµè§ˆå™¨ä¼šæ ¹æ®å…ƒç´ çš„æ–°å±æ€§é‡æ–°ç»˜åˆ¶ï¼Œä½¿å…ƒç´ å‘ˆç°æ–°çš„å¤–è§‚ã€‚</li>
<li>é‡æ’/å›æµï¼šæ˜¯æŒ‡å…ƒç´ çš„ä½ç½®æˆ–å°ºå¯¸å‘ç”Ÿäº†å˜åŒ–ï¼Œæµè§ˆå™¨éœ€è¦é‡æ–°è®¡ç®—æ¸²æŸ“æ ‘ï¼Œè€Œæ–°çš„æ¸²æŸ“æ ‘å»ºç«‹åï¼Œæµè§ˆå™¨ä¼šé‡æ–°ç»˜åˆ¶é¡µé¢ã€‚</li>
</ul>
<p><code>é‡ç»˜ç›¸å¯¹äºé‡æ’è¿˜å¥½ä¸€äº›ï¼Œé‡ç»˜ä»…ä»…æ”¹å˜å˜åŒ–å…ƒç´ çš„æ ·å¼å³å¯ï¼Œä½†é‡æ’ï¼ˆå›æµï¼‰åˆ™ä¼šé‡æ–°è®¡ç®—æ‰€æœ‰å…ƒç´ ä¹‹é—´çš„ä½ç½®å…³ç³»ç„¶åé‡æ–°ç»˜åˆ¶å…ƒç´ </code><br><br><code>å¦‚æœé¢‘ç¹æ“ä½œDOMï¼Œå…¶å¿…ç„¶å¸¦æ¥æ€§èƒ½å˜ä½ï¼Œæµè§ˆå™¨å¡æ…¢</code></p>
<h4 id="ä¸ºä½•éœ€è¦è™šæ‹ŸDOMï¼Ÿ"><a href="#ä¸ºä½•éœ€è¦è™šæ‹ŸDOMï¼Ÿ" class="headerlink" title="ä¸ºä½•éœ€è¦è™šæ‹ŸDOMï¼Ÿ"></a>ä¸ºä½•éœ€è¦è™šæ‹ŸDOMï¼Ÿ</h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹çœŸå®çš„DOMå…ƒç´ ï¼Œæˆ‘ä»¬æ‰“å¼€æŸåº¦çš„é¦–é¡µï¼Œåœ¨æ§åˆ¶å°è¾“å…¥ä»¥ä¸‹ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var dom1 = document.querySelectorAll(&apos;div&apos;)[0]</span><br><span class="line">for ( let x in dom1 ) &#123;</span><br><span class="line">  console.log(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ä¸€ä¸ªdivä¸‹å…¶å®æ˜¯æœ‰å¾ˆå¤šå±æ€§çš„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">align</span><br><span class="line">title</span><br><span class="line">lang</span><br><span class="line">translate</span><br><span class="line">dir</span><br><span class="line">dataset</span><br><span class="line">hidden</span><br><span class="line">tabIndex</span><br><span class="line">accessKey</span><br><span class="line">draggable</span><br><span class="line">spellcheck</span><br><span class="line">autocapitalize</span><br><span class="line">contentEditable</span><br><span class="line">isContentEditable</span><br><span class="line">......ç­‰ä¸Šç™¾ä¸ª</span><br></pre></td></tr></table></figure></p>
<p>ä¸€ä¸ªDOMæ‹¥æœ‰è¿™ä¹ˆå¤šå±æ€§ï¼Œè¿™ä¹Ÿæ˜¯å¸¦æ¥æ€§èƒ½é—®é¢˜çš„åŸå› ä¹‹ä¸€ï¼Œæ’‡å¼€æˆ‘ä»¬ç”¨ä¸ä¸Šçš„å±æ€§ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥<code>ä½¿ç”¨jsæ¥æ¨¡æ‹Ÿä¸€ä¸ªä»…ä¿ç•™æˆ‘ä»¬éœ€è¦çš„å±æ€§çš„DOM</code>ï¼Œè¿™æ ·çš„æ¨¡æ‹ŸDOMå…¶å®å°±æ˜¯<code>è™šæ‹ŸDOM</code>ã€‚<br><br>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹ä»£ç æ¨¡æ‹Ÿä¸€ä¸ªå†…å®¹ä¸ºâ€™Hello Wordâ€™ï¼Œidåä¸classåä¸ºtestçš„divå…ƒç´ ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  tag: &apos;div&apos;,</span><br><span class="line">  id: &apos;test&apos;,</span><br><span class="line">  className: &apos;test&apos;</span><br><span class="line">  text: &apos;Hello Word&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Vueã€Reactéƒ½ä½¿ç”¨äº†è™šæ‹ŸDOMæŠ€æœ¯ï¼Œè®©æ–°ã€æ—§DOMçš„å˜åŒ–å¯¹æ¯”åœ¨Jså±‚å®Œæˆï¼Œæœ€åä»…ä¿®æ”¹å˜åŒ–äº†çš„DOMï¼Œç›´æ¥é¿å…äº†é¢‘ç¹æ“ä½œDOMçš„æƒ…å†µï¼Œå¤§å¤§æå‡é¡µé¢æ€§èƒ½ã€‚</p>
<h3 id="Vnode"><a href="#Vnode" class="headerlink" title="Vnode"></a>Vnode</h3><p>Vnodeå°±æ˜¯è™šæ‹ŸDOMæŠ€æœ¯åœ¨Vueä¸­çš„å®ç°ï¼Œå®ƒçš„æºç åœ¨<a href="https://github.com/vuejs/vue/blob/dev/src/core/vdom/vnode.js" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼Œå®ƒåœ¨æ¨¡æ‹ŸDOMçš„æƒ…å†µä¸‹åˆæ·»åŠ äº†å¾ˆå¤šæ¡†æ¶æœ¬èº«éœ€è¦çš„å±æ€§ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export default class VNode &#123;</span><br><span class="line">  tag: string | void;</span><br><span class="line">  data: VNodeData | void;</span><br><span class="line">  children: ?Array&lt;VNode&gt;;</span><br><span class="line">  text: string | void;</span><br><span class="line">  elm: Node | void;</span><br><span class="line">  ns: string | void;</span><br><span class="line">  context: Component | void; // rendered in this component&apos;s scope</span><br><span class="line">  key: string | number | void;</span><br><span class="line">  componentOptions: VNodeComponentOptions | void;</span><br><span class="line">  componentInstance: Component | void; // component instance</span><br><span class="line">  parent: VNode | void; // component placeholder node</span><br><span class="line"></span><br><span class="line">  // code...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æœ‰äº†è™šæ‹ŸDOMé‚£ä¹ˆå°±è¦æœ‰å¯¹æ¯”æ–°ã€æ—§è™šæ‹ŸDOMçš„å˜åŒ–ç®—æ³•ï¼Œè¿™ç§ç®—æ³•å°±å«Diffç®—æ³•ï¼š</p>
<h3 id="Diffç®—æ³•"><a href="#Diffç®—æ³•" class="headerlink" title="Diffç®—æ³•"></a>Diffç®—æ³•</h3><h4 id="Diffç®—æ³•åŒçº§æ¯”è¾ƒ"><a href="#Diffç®—æ³•åŒçº§æ¯”è¾ƒ" class="headerlink" title="Diffç®—æ³•åŒçº§æ¯”è¾ƒ"></a>Diffç®—æ³•åŒçº§æ¯”è¾ƒ</h4><p>æ±‚ä¸¤ä¸ªä»»æ„æ ‘ä¹‹é—´çš„æœ€å°ä¿®æ”¹æ˜¯ä¸€ä¸ªæ—¶é—´å¤æ‚åº¦ä¸ºO(n^3)é—®é¢˜ã€‚è¿™æ ·çš„æ—¶é—´å¤æ‚åº¦æ˜¯æˆ‘ä»¬æ— æ³•æ¥å—çš„ã€‚<br>åœ¨Webåº”ç”¨ä¸­å°†ç»„ä»¶ç§»åŠ¨åˆ°æ ‘ä¸­çš„ä¸åŒçº§åˆ«æ˜¯éå¸¸ç½•è§çš„ï¼Œé€šå¸¸åªåœ¨å­©å­ä¸­é—´æ¨ªå‘ç§»åŠ¨ã€‚<br>æ‰€ä»¥Diffç®—æ³•é‡‡ç”¨çš„æ˜¯<code>åŒçº§æ¯”è¾ƒ</code>ï¼Œå°†ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦é™ä½åˆ°äº†O(N)ï¼Œè¿™å¤§å¤§é™ä½äº†å¤æ‚æ€§ï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šé€ æˆå¾ˆå¤§æŸå¤±ï¼Œæ­£å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff1.png" alt="åŒçº§æ¯”è¾ƒ"></p>
<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬è¿›è¡Œäº†è·¨çº§åˆ«çš„ç»„ä»¶ç§»åŠ¨æ“ä½œï¼Œå®é™…ä¸Šæ˜¯ä¼šå…ˆåˆ é™¤DOMï¼Œå†åœ¨å¯¹åº”çš„å±‚çº§ä¸Šæ–°å»ºä¸€ä¸ªDOMã€‚</p>
<h4 id="å¾ªç¯ä¸­ä¸ºä½•éœ€è¦keyå±æ€§ï¼Ÿ"><a href="#å¾ªç¯ä¸­ä¸ºä½•éœ€è¦keyå±æ€§ï¼Ÿ" class="headerlink" title="å¾ªç¯ä¸­ä¸ºä½•éœ€è¦keyå±æ€§ï¼Ÿ"></a>å¾ªç¯ä¸­ä¸ºä½•éœ€è¦keyå±æ€§ï¼Ÿ</h4><p>æˆ‘ä»¬çœ‹è¿™å¼ å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff2.png" alt="ä¸ºä½•éœ€è¦key"></p>
<p>å¦‚æœæˆ‘ä»¬å¾ªç¯ç”Ÿæˆäº†5ä¸ªç»„ä»¶ï¼Œç„¶åæˆ‘ä»¬åˆæ’å…¥äº†ä¸€ä¸ªæ–°çš„åŒç±»ç»„ä»¶ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´å¾ˆéš¾çŸ¥é“å¦‚ä½•åœ¨ä¸¤ä¸ªç»„ä»¶Listsä¸­å»ºç«‹æ˜ å°„ï¼Œæ‰€ä»¥å°±ä¼šå˜æˆä¸Šå›¾å·¦ä¾§æ‰€ç¤ºï¼ŒæŒ‰é¡ºåºä¸€ä¸€å»ºç«‹å…³è”ã€‚<br>å¦‚æœæœ‰äº†keyçš„å­˜åœ¨æƒ…å†µåˆ™å¤§ä¸ä¸€æ ·ï¼Œå®ƒèƒ½å¾ˆå®¹æ˜“çš„å¸®åŠ©ä»£ç è§£å†³æ˜ å°„é—®é¢˜ï¼Œè®©ä»£ç åœ¨æ­£ç¡®çš„åœ°æ–¹è¿›è¡Œæ­£ç¡®çš„æ“ä½œï¼Œè¿™å¯¹ä»£ç çš„æ€§èƒ½æå‡ä¹Ÿæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚</p>
<h4 id="ç®€å•åˆ†æDiffç®—æ³•"><a href="#ç®€å•åˆ†æDiffç®—æ³•" class="headerlink" title="ç®€å•åˆ†æDiffç®—æ³•"></a>ç®€å•åˆ†æDiffç®—æ³•</h4><p>æˆ‘ä»¬ä»¥Vueï¼ˆv2.6.8ï¼‰ä»£ç ä¸ºä¾‹ï¼Œä»£ç ä½ç½®åœ¨<a href="https://github.com/vuejs/vue/blob/dev/src/core/vdom/patch.js" target="_blank" rel="noopener">src/core/vdom/patch.js</a>ä¸­ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬å…ˆæ˜ç¡®å‡ ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li><p>å·¥å…·æ–¹æ³•isUndefã€isDefç­‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// åˆ¤æ–­væ˜¯å¦æ˜¯undefinedæˆ–null</span><br><span class="line">export function isUndef (v: any): boolean %checks &#123;</span><br><span class="line">  return v === undefined || v === null</span><br><span class="line">&#125;</span><br><span class="line">// åˆ¤æ–­væ˜¯å¦ä¸æ˜¯undefinedæˆ–null</span><br><span class="line">export function isDef (v: any): boolean %checks &#123;</span><br><span class="line">  return v !== undefined &amp;&amp; v !== null</span><br><span class="line">&#125;</span><br><span class="line">// å…¶ä»–å·¥å…·æ–¹æ³•å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹</span><br></pre></td></tr></table></figure>
</li>
<li><p>sameVnodeï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªVnode</span><br><span class="line">function sameVnode (a, b) &#123;</span><br><span class="line">  return (</span><br><span class="line">    a.key === b.key &amp;&amp; (</span><br><span class="line">      (</span><br><span class="line">        a.tag === b.tag &amp;&amp;</span><br><span class="line">        a.isComment === b.isComment &amp;&amp;</span><br><span class="line">        isDef(a.data) === isDef(b.data) &amp;&amp;</span><br><span class="line">        sameInputType(a, b)</span><br><span class="line">      ) || (</span><br><span class="line">        isTrue(a.isAsyncPlaceholder) &amp;&amp;</span><br><span class="line">        a.asyncFactory === b.asyncFactory &amp;&amp;</span><br><span class="line">        isUndef(b.asyncFactory.error)</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>nodeOps å°è£…äº†ä¸€äº›åŸç”ŸDOMæ“ä½œæ–¹æ³•ï¼Œåœ¨platforms\web\runtime\node-ops.jsä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// code...</span><br><span class="line">export function createElementNS (namespace: string, tagName: string): Element &#123;</span><br><span class="line">  return document.createElementNS(namespaceMap[namespace], tagName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function createTextNode (text: string): Text &#123;</span><br><span class="line">  return document.createTextNode(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function createComment (text: string): Comment &#123;</span><br><span class="line">  return document.createComment(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function insertBefore (parentNode: Node, newNode: Node, referenceNode: Node) &#123;</span><br><span class="line">  parentNode.insertBefore(newNode, referenceNode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function removeChild (node: Node, child: Node) &#123;</span><br><span class="line">  node.removeChild(child)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function appendChild (node: Node, child: Node) &#123;</span><br><span class="line">  node.appendChild(child)</span><br><span class="line">&#125;</span><br><span class="line">// code...</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h4><p>å¯¹æ¯”æ–°ã€è€vnodeï¼Œè¿›è¡Œæœ€å°ç¨‹åº¦çš„ä¿®æ”¹</p>
<ul>
<li>å¦‚æœæ˜¯<code>åˆå§‹åŒ–</code>ä¼šä¼ ä»¥ä¸‹å‡ ä¸ªå‚æ•°ï¼ˆcore\instance\lifecycle.jsï¼‰ï¼š</li>
<li><code>vm.__patch__(vm.$el, vnode, hydrating, false)</code> </li>
<li>// vm.$el æ˜¯è¦æŒ‚è½½åˆ°çš„DOMï¼Œvnodeå°±æ˜¯vnodeï¼Œhydratingç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ä¸ç”¨ç®¡ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯removeOnly</li>
<li>å¦‚æœæ˜¯<code>æ›´æ–°</code>ä¼šä¼ ä¸¤ä¸ªå‚æ•°</li>
<li><code>vm.__patch__(prevVnode, vnode)</code> </li>
<li>// prevVnode æ˜¯æ—§ vNodeï¼Œvnode æ˜¯æ–° vNode<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">core\vdom\patch.js</span><br><span class="line">return function patch (oldVnode, vnode, hydrating, removeOnly) &#123;</span><br><span class="line">  // vnodeä¸å­˜åœ¨ï¼ŒoldVnodeå­˜åœ¨ï¼Œè¯´æ˜èŠ‚ç‚¹è¢«ç§»é™¤äº†ï¼Œç›´æ¥è°ƒç”¨é”€æ¯é’©å­</span><br><span class="line">  if (isUndef(vnode)) &#123;</span><br><span class="line">    if (isDef(oldVnode)) invokeDestroyHook(oldVnode)</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  let isInitialPatch = false</span><br><span class="line">  const insertedVnodeQueue = []</span><br><span class="line">  // å¦‚æœoldVnodeä¸å­˜åœ¨çš„è¯ï¼Œå°±æ–°å»ºä¸€ä¸ªæ ¹èŠ‚ç‚¹</span><br><span class="line">  if (isUndef(oldVnode)) &#123;</span><br><span class="line">    // empty mount (likely as component), create new root element</span><br><span class="line">    isInitialPatch = true</span><br><span class="line">    createElm(vnode, insertedVnodeQueue)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line"></span><br><span class="line">    // ğŸ‘‡æ ¹æ® oldVnode æ˜¯å¦å­˜åœ¨ nodeType å±æ€§ æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªçœŸå®DOMèŠ‚ç‚¹</span><br><span class="line">    // ğŸ‘‡å¦‚æœå­˜åœ¨ nodeType è¯´æ˜å½“å‰èµ°çš„æ˜¯ åˆå§‹åŒ– æµç¨‹</span><br><span class="line">    const isRealElement = isDef(oldVnode.nodeType)</span><br><span class="line"></span><br><span class="line">    // èµ°updateæµç¨‹ ä¸” æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´æ¥è°ƒç”¨ patchVnode æ–¹æ³•</span><br><span class="line">    if (!isRealElement &amp;&amp; sameVnode(oldVnode, vnode)) &#123;</span><br><span class="line">      // ä¿®è¡¥ç°æœ‰æ ¹èŠ‚ç‚¹</span><br><span class="line">      patchVnode(oldVnode, vnode, insertedVnodeQueue, null, null, removeOnly)</span><br><span class="line">    &#125; </span><br><span class="line">    else &#123;</span><br><span class="line">      // oldVnode æ˜¯ çœŸå®èŠ‚ç‚¹ï¼Œèµ° init æµç¨‹</span><br><span class="line">      if (isRealElement) &#123;</span><br><span class="line">        // mounting to a real element</span><br><span class="line">        // check if this is server-rendered content and if we can perform</span><br><span class="line">        // a successful hydration.</span><br><span class="line">        // Vnodeåœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„ä¸€äº›å¤„ç†ï¼Œè¿™é‡Œæš‚ä¸”ä¸çœ‹</span><br><span class="line">        // å¦‚æœoldVnodeçš„æ˜¯ä¸€ä¸ªElementèŠ‚ç‚¹ &amp;&amp; å­˜åœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„å±æ€§</span><br><span class="line">        if (oldVnode.nodeType === 1 &amp;&amp; oldVnode.hasAttribute(SSR_ATTR)) &#123;</span><br><span class="line">          // åˆ™ç§»é™¤å…¶SSRå±æ€§ï¼Œå†å°†hydratingè®¾ç½®ä¸ºtrue</span><br><span class="line">          oldVnode.removeAttribute(SSR_ATTR)</span><br><span class="line">          hydrating = true</span><br><span class="line">        &#125;</span><br><span class="line">        if (isTrue(hydrating)) &#123;</span><br><span class="line">          if (hydrate(oldVnode, vnode, insertedVnodeQueue)) &#123;</span><br><span class="line">            invokeInsertHook(vnode, insertedVnodeQueue, true)</span><br><span class="line">            return oldVnode</span><br><span class="line">          &#125; else if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">            warn(</span><br><span class="line">              &apos;The client-side rendered virtual DOM tree is not matching &apos; +</span><br><span class="line">              &apos;server-rendered content. This is likely caused by incorrect &apos; +</span><br><span class="line">              &apos;HTML markup, for example nesting block-level elements inside &apos; +</span><br><span class="line">              &apos;&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing &apos; +</span><br><span class="line">              &apos;full client-side render.&apos;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // either not server-rendered, or hydration failed.</span><br><span class="line">        // create an empty node and replace it</span><br><span class="line">        // ä¸æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„è¯ï¼Œä¸”æ˜¯åˆå§‹åŒ–æµç¨‹ï¼ŒæŠŠoldVnodeæ›¿æ¢ä¸ºä¸€ä¸ªç©ºçš„vNode</span><br><span class="line">        oldVnode = emptyNodeAt(oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // å½“å‰èŠ‚ç‚¹ä¸å…¶çˆ¶èŠ‚ç‚¹</span><br><span class="line">      const oldElm = oldVnode.elm</span><br><span class="line">      const parentElm = nodeOps.parentNode(oldElm)</span><br><span class="line"></span><br><span class="line">      // åˆ›å»ºä¸€ä¸ªæ–°çš„ node</span><br><span class="line">      createElm(</span><br><span class="line">        vnode,</span><br><span class="line">        insertedVnodeQueue,</span><br><span class="line">        // extremely rare edge case: do not insert if old element is in a</span><br><span class="line">        // leaving transition. Only happens when combining transition +</span><br><span class="line">        // keep-alive + HOCs. (#4590)</span><br><span class="line">        oldElm._leaveCb ? null : parentElm,</span><br><span class="line">        nodeOps.nextSibling(oldElm)</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      // update parent placeholder node element, recursively</span><br><span class="line">      // é€’å½’æ›´æ–°çˆ¶èŠ‚ç‚¹å ä½èŠ‚ç‚¹å…ƒç´ </span><br><span class="line">      if (isDef(vnode.parent)) &#123;</span><br><span class="line">        let ancestor = vnode.parent</span><br><span class="line">        const patchable = isPatchable(vnode)</span><br><span class="line">        while (ancestor) &#123;</span><br><span class="line">          for (let i = 0; i &lt; cbs.destroy.length; ++i) &#123;</span><br><span class="line">            cbs.destroy[i](ancestor)</span><br><span class="line">          &#125;</span><br><span class="line">          ancestor.elm = vnode.elm</span><br><span class="line">          if (patchable) &#123;</span><br><span class="line">            for (let i = 0; i &lt; cbs.create.length; ++i) &#123;</span><br><span class="line">              cbs.create[i](emptyNode, ancestor)</span><br><span class="line">            &#125;</span><br><span class="line">            // #6513</span><br><span class="line">            // invoke insert hooks that may have been merged by create hooks.</span><br><span class="line">            // e.g. for directives that uses the &quot;inserted&quot; hook.</span><br><span class="line">            const insert = ancestor.data.hook.insert</span><br><span class="line">            if (insert.merged) &#123;</span><br><span class="line">              // start at index 1 to avoid re-invoking component mounted hook</span><br><span class="line">              for (let i = 1; i &lt; insert.fns.length; i++) &#123;</span><br><span class="line">                insert.fns[i]()</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            registerRef(ancestor)</span><br><span class="line">          &#125;</span><br><span class="line">          ancestor = ancestor.parent</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // æœ‰çˆ¶å…ƒç´ </span><br><span class="line">      if (isDef(parentElm)) &#123;</span><br><span class="line">        removeVnodes(parentElm, [oldVnode], 0, 0)</span><br><span class="line">      &#125; </span><br><span class="line">      // æ²¡æœ‰çˆ¶å…ƒç´ è§¦å‘é”€æ¯</span><br><span class="line">      else if (isDef(oldVnode.tag)) &#123;</span><br><span class="line">        invokeDestroyHook(oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch)</span><br><span class="line">  return vnode.elm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>patch æ–¹æ³•é’ˆå¯¹<code>åˆå§‹åŒ–</code>ä¸<code>æ›´æ–°</code>è¿™ä¸¤ç§æƒ…å†µåšå¤„ç†ï¼Œ<br>å…³äº<code>åˆå§‹åŒ–</code>ä¸<code>æ›´æ–°</code>çš„åˆ¤æ–­ï¼špatch å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ çš„å¦‚æœæ˜¯ä¸€ä¸ªçœŸå®DOMï¼Œé‚£ä¹ˆå°±ä¼šæœ‰nodeTypeå±æ€§ï¼Œåˆ™æ˜¯åˆå§‹åŒ–ã€‚<br>å¦‚æœæ˜¯æ›´æ–°ï¼Œä¸”æ–°æ—§ä¸¤ä¸ªvNodeå€¼å¾—æ¯”è¾ƒï¼ˆå³è°ƒç”¨samevnodeæ–¹æ³•è¿”å›trueï¼Œè¯´æ˜æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹ï¼‰åˆ™ä¼šè°ƒç”¨ patchVnode è¿›ä¸€æ­¥æ¯”è¾ƒã€‚</p>
<h4 id="patchVnode"><a href="#patchVnode" class="headerlink" title="patchVnode"></a>patchVnode</h4><p>ä¿®è¡¥vnode<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">function patchVnode ( oldVnode, vnode, insertedVnodeQueue, ownerArray, index, removeOnly ) &#123;</span><br><span class="line">  // å¦‚æœæ˜¯åŒä¸€ä¸ªvnode return</span><br><span class="line">  if (oldVnode === vnode) &#123; return &#125;</span><br><span class="line">  if (isDef(vnode.elm) &amp;&amp; isDef(ownerArray)) &#123;</span><br><span class="line">    // å…‹éš†é‡ç”¨ vnode</span><br><span class="line">    vnode = ownerArray[index] = cloneVNode(vnode)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // è®¾ç½® æ–°vnodeçš„elm ä¸ æ—§vnode.elm ç›¸åŒï¼ˆéƒ½ä¸ºåŒä¸€ä¸ªDOMï¼‰</span><br><span class="line">  const elm = vnode.elm = oldVnode.elm</span><br><span class="line"></span><br><span class="line">  if (isTrue(oldVnode.isAsyncPlaceholder)) &#123;</span><br><span class="line">    if (isDef(vnode.asyncFactory.resolved)) &#123;</span><br><span class="line">      hydrate(oldVnode.elm, vnode, insertedVnodeQueue)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      vnode.isAsyncPlaceholder = true</span><br><span class="line">    &#125;</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  // é™æ€æ ‘é‡ç”¨å…ƒç´ </span><br><span class="line">  if (isTrue(vnode.isStatic) &amp;&amp;</span><br><span class="line">    isTrue(oldVnode.isStatic) &amp;&amp;</span><br><span class="line">    vnode.key === oldVnode.key &amp;&amp;</span><br><span class="line">    (isTrue(vnode.isCloned) || isTrue(vnode.isOnce))</span><br><span class="line">  ) &#123;</span><br><span class="line">    vnode.componentInstance = oldVnode.componentInstance</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  let i</span><br><span class="line">  const data = vnode.data</span><br><span class="line">  if (isDef(data) &amp;&amp; isDef(i = data.hook) &amp;&amp; isDef(i = i.prepatch)) &#123;</span><br><span class="line">    i(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const oldCh = oldVnode.children</span><br><span class="line">  const ch = vnode.children</span><br><span class="line">  if (isDef(data) &amp;&amp; isPatchable(vnode)) &#123;</span><br><span class="line">    for (i = 0; i &lt; cbs.update.length; ++i) cbs.update[i](oldVnode, vnode)</span><br><span class="line">    if (isDef(i = data.hook) &amp;&amp; isDef(i = i.update)) i(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  if (isUndef(vnode.text)) &#123;</span><br><span class="line">    // å¦‚æœæ–°æ—§ vNodeéƒ½æœ‰ children åˆ™è°ƒç”¨ updateChildren æ–¹æ³•æ¥å¯¹æ¯”ä»–ä¿©çš„ children</span><br><span class="line">    if (isDef(oldCh) &amp;&amp; isDef(ch)) &#123;</span><br><span class="line">      if (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly)</span><br><span class="line">    &#125; else if (isDef(ch)) &#123;</span><br><span class="line">      if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">        checkDuplicateKeys(ch)</span><br><span class="line">      &#125;</span><br><span class="line">      if (isDef(oldVnode.text)) nodeOps.setTextContent(elm, &apos;&apos;)</span><br><span class="line">      addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue)</span><br><span class="line">    &#125; else if (isDef(oldCh)) &#123;</span><br><span class="line">      removeVnodes(elm, oldCh, 0, oldCh.length - 1)</span><br><span class="line">    &#125; else if (isDef(oldVnode.text)) &#123;</span><br><span class="line">      nodeOps.setTextContent(elm, &apos;&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else if (oldVnode.text !== vnode.text) &#123;</span><br><span class="line">    nodeOps.setTextContent(elm, vnode.text)</span><br><span class="line">  &#125;</span><br><span class="line">  if (isDef(data)) &#123;</span><br><span class="line">    if (isDef(i = data.hook) &amp;&amp; isDef(i = i.postpatch)) i(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œä¸»è¦çœ‹è¿™æ®µï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (isDef(oldCh) &amp;&amp; isDef(ch)) &#123;</span><br><span class="line">  if (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>å¦‚æœ oldVnode ä¸ vNode éƒ½æœ‰ children åˆ™è°ƒç”¨ <code>updateChildren</code> æ–¹æ³•æ¥å¯¹æ¯”ä»–ä¿©çš„ childrenï¼Œ<br>åœ¨ updateChildren æ–¹æ³•ä¸­å°±ä¼šç”¨åˆ° <code>Diffç®—æ³•</code> æ¥å¯¹æ¯”ã€æ›´æ–°èŠ‚ç‚¹ï¼ŒåŒæ—¶å† updateChildren ä¸­ä¹Ÿä¼šè°ƒç”¨ patchVnode ç»§ç»­å¯¹æ¯”ä¸‹ä¸€çº§å­èŠ‚ç‚¹ã€‚</li>
<li>å¦‚æœoldVnode æ²¡æœ‰ childrenï¼Œè€Œ vNode æœ‰ï¼Œåˆ™è°ƒç”¨ addVnode æ–¹æ³•ï¼Œæ·»åŠ æ‰€æœ‰çš„ childrenã€‚</li>
<li>å¦‚æœ oldVnode æœ‰ childrenï¼Œè€Œ vNode æœ‰ï¼Œåˆ™è°ƒç”¨ removeVnode æ–¹æ³•ï¼Œç§»é™¤åŸæœ‰çš„ childrenã€‚</li>
<li>å¦‚æœ oldVnode ä¸ vNode éƒ½æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œåˆ™ä¼šç”¨ vNode çš„æ–‡æœ¬æ›¿æ¢ oldVnode çš„æ–‡æœ¬ã€‚</li>
</ol>
<h4 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren"></a>updateChildren</h4><p>è¿™ä¸ªæ–¹æ³•æ˜¯ diff ç®—æ³•çš„æ ¸å¿ƒï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">function updateChildren (parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) &#123;</span><br><span class="line">  let oldStartIdx = 0 // æ—§listèµ·å§‹ç´¢å¼•</span><br><span class="line">  let newStartIdx = 0 // æ–°listèµ·å§‹ç´¢å¼•</span><br><span class="line">  let oldEndIdx = oldCh.length - 1 // æ—§listç»“å°¾ç´¢å¼•</span><br><span class="line">  let oldStartVnode = oldCh[0] // æ—§çš„èµ·å§‹vnodeåˆå§‹èµ‹å€¼ä¸ºlistçš„ç¬¬ä¸€ä¸ª</span><br><span class="line">  let oldEndVnode = oldCh[oldEndIdx] // æ—§çš„ç»“å°¾vnodeåˆå§‹èµ‹å€¼ä¸ºlistçš„æœ€åä¸€ä¸ª</span><br><span class="line">  let newEndIdx = newCh.length - 1 // æ–°listç»“å°¾ç´¢å¼•</span><br><span class="line">  let newStartVnode = newCh[0] // æ—§çš„èµ·å§‹vnodeåˆå§‹èµ‹å€¼ä¸ºlistçš„ç¬¬ä¸€ä¸ª</span><br><span class="line">  let newEndVnode = newCh[newEndIdx] // æ—§çš„ç»“å°¾vnodeåˆå§‹èµ‹å€¼ä¸ºlistçš„æœ€åä¸€ä¸ª</span><br><span class="line">  /**</span><br><span class="line">   * å˜é‡å®šä¹‰</span><br><span class="line">   * oldKeyToIdxè¦å­˜ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå­˜æ”¾çš„å†…å®¹æ˜¯oldVnodeçš„key</span><br><span class="line">   * idxInOldä¼šå­˜æ”¾æ ¹æ®å“ˆå¸Œè¡¨ä¸­çš„keyæ‰¾åˆ°çš„å¯¹åº”oldVnode</span><br><span class="line">   * vnodeToMoveæˆ‘ä»¬è¦ç§»åŠ¨çš„vnode</span><br><span class="line">   * refElmå°±åˆ°ä¸‹é¢å»çœ‹æ³¨é‡ŠæŠŠ</span><br><span class="line">   */    </span><br><span class="line">  let oldKeyToIdx, idxInOld, vnodeToMove, refElm</span><br><span class="line"></span><br><span class="line">  // removeOnlyæ˜¯ä¸€ä¸ªç”¨äº&lt;transition-group&gt;çš„ç‰¹æ®Šçš„flag</span><br><span class="line">  // ä»¥ä¿è¯ç§»é™¤æœ‰è¿‡æ¸¡æ•ˆæœçš„çš„å…ƒç´ æ—¶ä¿æŒå®ƒæ­£ç¡®çš„å®šä½</span><br><span class="line">  const canMove = !removeOnly</span><br><span class="line"></span><br><span class="line">  if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">    checkDuplicateKeys(newCh)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  while (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line"></span><br><span class="line">    // oldStartVnodeä¸å­˜åœ¨ï¼Œåˆ™å°†oldStartVnodeèµ‹å€¼ä¸ºä¸‹ä¸€ä¸ªvnode</span><br><span class="line">    if (isUndef(oldStartVnode)) &#123;</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx] // Vnode has been moved left</span><br><span class="line"></span><br><span class="line">    // oldEndVnodeä¸å­˜åœ¨åˆ™å°†oldEndVnodeèµ‹å€¼ä¸ºä¸Šä¸€ä¸ªvnode</span><br><span class="line">    &#125; else if (isUndef(oldEndVnode)) &#123;</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line"></span><br><span class="line">    // å¦‚æœoldStartVnode, newStartVnodeä¸ºåŒä¸€ä¸ªvnodeï¼Œç›´æ¥å»patchVnodeï¼ˆæ‰“è¡¥ä¸ï¼‰</span><br><span class="line">    // ç„¶åï¼Œæ–°æ—§startVnodeå„å‘å‰å‰è¿›ä¸€æ ¼</span><br><span class="line">    &#125; else if (sameVnode(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">      patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line"></span><br><span class="line">    // å¦‚æœoldEndVnode, newEndVnodeä¸ºåŒä¸€ä¸ªvnodeï¼Œç›´æ¥å»patchVnodeï¼ˆæ‰“è¡¥ä¸ï¼‰</span><br><span class="line">    // ç„¶åï¼Œæ–°æ—§endVnodeå„å‘ååé€€ä¸€æ ¼</span><br><span class="line">    &#125; else if (sameVnode(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">      patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">      newEndVnode = newCh[--newEndIdx]</span><br><span class="line"></span><br><span class="line">    // å¦‚æœoldStartVnode, newEndVnodeä¸ºåŒä¸€ä¸ªvnodeï¼ˆvnodeè¢«ç§»åŠ¨åˆ°å³è¾¹å»äº†ï¼‰</span><br><span class="line">    // oldStartVnodeå‰è¿›ä¸€æ ¼</span><br><span class="line">    // newEndVnodeåé€€ä¸€æ ¼</span><br><span class="line">    &#125; else if (sameVnode(oldStartVnode, newEndVnode)) &#123; // Vnode moved right</span><br><span class="line">      patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)</span><br><span class="line">      canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm))</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">      newEndVnode = newCh[--newEndIdx]</span><br><span class="line"></span><br><span class="line">    // å¦‚æœoldEndVnode, newStartVnodeæ˜¯åŒä¸€ä¸ªvnodeï¼Œè¯´æ˜vnodeè¢«ç§»åˆ°å·¦è¾¹å»äº†</span><br><span class="line">    // newStartVnodeå‰è¿›ä¸€æ ¼</span><br><span class="line">    // oldEndVnodeåé€€ä¸€æ ¼</span><br><span class="line">    &#125; else if (sameVnode(oldEndVnode, newStartVnode)) &#123; // Vnode moved left</span><br><span class="line">      patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">      canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm)</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line"></span><br><span class="line">    // æœ€åï¼Œæ‰€æœ‰çš„å¯¹æ¯”ä¸ä¸Š</span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">      if (isUndef(oldKeyToIdx)) oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">      // åˆ›å»ºäº†ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå…¶å­˜æ”¾çš„å†…å®¹æ˜¯old vnodeçš„key</span><br><span class="line">      idxInOld = isDef(newStartVnode.key) ? oldKeyToIdx[newStartVnode.key] : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">      // old vnodeçš„å“ˆå¸Œè¡¨ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™è¯´æ˜æ˜¯æ–°å…ƒç´ å•Šï¼Œè¿™é‡Œå°±æ–°å»ºä¸€ä¸ªå…ƒç´ </span><br><span class="line">      if (isUndef(idxInOld)) &#123; // New element æ–°åŠ è¿›æ¥çš„å…ƒç´ </span><br><span class="line">        createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)</span><br><span class="line">      // else å°±æ˜¯æ‰¾åˆ°å•¦ï¼Œ</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        // è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬æ‰¾åˆ°çš„å’Œ newVnodeçš„startIndex ç´¢å¼•ç›¸åŒçš„ oldVnodeï¼Œæˆ‘ä»¬è¦æŠŠå®ƒç§»åˆ°å½“å‰çš„oldStartVnodeçš„å‰é¢å»</span><br><span class="line">        vnodeToMove = oldCh[idxInOld]</span><br><span class="line">        if (sameVnode(vnodeToMove, newStartVnode)) &#123;</span><br><span class="line">          patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">          oldCh[idxInOld] = undefined</span><br><span class="line">          canMove &amp;&amp; nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          // same key but different element. treat as new element</span><br><span class="line">          // ä¸è¿‡å‘¢ï¼Œä¸‡ä¸€keyç›¸åŒï¼Œä½†æ˜¯é€šè¿‡sameVnodeæ–¹æ³•æ¯”è¾ƒå‡ºæ¥çš„ç»“æœæ˜¯ä¸ç›¸åŒï¼Œåˆ™newä¸€ä¸ªå…ƒç´ ï¼Œæ’åˆ°å½“å‰çš„oldStartVnodeçš„å‰é¢å»</span><br><span class="line">          createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  // è¿™é‡Œå°±å¾ªç¯å®Œæ¯•å•¦</span><br><span class="line">  // ä½†æ˜¯å¦‚æœè¿™é‡Œå‘ç° oldStartIdx &gt; oldEndIdx è¯´æ˜ï¼Œæœ‰æ–°å¢çš„å…ƒç´ </span><br><span class="line">  // æˆ‘ä»¬æŠŠå®ƒä»¬é€‰å‡ºæ¥ï¼Œç”¨refElmå­˜ä¸€ä¸‹ï¼Œç„¶åå•Šï¼Œä½¿ç”¨addVnodesæ‰¹é‡è°ƒç”¨åˆ›å»ºï¼ˆcreateElmï¼‰æŠŠè¿™äº›vnodeåŠ åˆ°çœŸå®DOMä¸­</span><br><span class="line">  if (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">    refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm</span><br><span class="line">    addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)</span><br><span class="line">  // elseå‘¢ï¼Œè¯´æ˜æ–°çš„vnodesæ¯”è€çš„å°‘</span><br><span class="line">  // æˆ‘ä»¬è°ƒç”¨removeVnodesæ–¹æ³•ï¼Œå‚æ•°åŒ…å«oldStartIdx ä¸ oldEndIdxï¼ŒæŠŠä¸è¦çš„åˆ æ‰å˜›</span><br><span class="line">  &#125; else if (newStartIdx &gt; newEndIdx) &#123;</span><br><span class="line">    removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>updateChildrençš„ä»£ç ä¸­å‘¢ï¼Œä¸»è¦æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œæ–°æ—§Listsä¸­æ— è®ºå“ªä¸€ä¸ªå…ˆå¾ªç¯å®Œéƒ½ä¼šé€€å‡ºå¾ªç¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">while (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">  // code...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// oldStartIdx &gt; oldEndIdxï¼Œæ–°Listsä¸­æ–°å¢äº†æŸäº›å…ƒç´ </span><br><span class="line">if (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">  // addVnodesæ“ä½œ</span><br><span class="line">  // code...</span><br><span class="line">&#125;</span><br><span class="line">// elseè¯´æ˜æ–°Listsä¸­ç§»é™¤äº†æŸäº›å…ƒç´ </span><br><span class="line">else if (newStartIdx &gt; newEndIdx) &#123;</span><br><span class="line">  // removeVnodesæ“ä½œ</span><br><span class="line">  // code...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç›´æ¥çœ‹æºç æ„Ÿè§‰å¤´éƒ½ç‚¸äº†ï¼Œè¿™é‡Œé€šè¿‡ç”»å›¾çš„æ–¹å¼ä¼šæ›´åˆé€‚ä¸€äº›ã€‚<br><code>æ³¨æ„ï¼šä»¥ä¸‹æ¯å¼ å›¾ä¹‹é—´æ²¡æœ‰è”ç³»</code></p>
<p>é¦–å…ˆä¼šåœ¨æ–°æ—§Listsçš„å¤´å°¾å®šä¹‰å„å®šä¹‰ä¸€ä¸ªæ ‡è®°ï¼Œåˆ†åˆ«ä¸ºï¼šoldStartIdxï¼ŒoldEndIdxï¼ŒnewStartIdxï¼ŒnewEndIdxï¼Œç”¨å›¾è¡¨ç¤ºæ˜¯è¿™ä¸ªæ ·å­ï¼š<br><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff3.jpg" alt="diff3"></p>
<ol>
<li><p>oldStartVnode, newStartVnodeç›¸åŒçš„æƒ…å†µï¼š<br>æ‰§è¡ŒpatchVnodeæ–¹æ³•<br>oldStartVnodeä¸newStartVnodeéƒ½å‰è¿›ä¸€æ ¼<br>å®Œæˆè¿™äº›æ“ä½œå°±å˜æˆäº†ä¸‹å›¾è¿™æ ·ï¼š<br><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff4.jpg" alt="diff4"></p>
</li>
<li><p>oldEndVnode, newEndVnodeç›¸åŒçš„æƒ…å†µï¼š<br>æ‰§è¡ŒpatchVnodeæ–¹æ³•<br>oldEndVnodeä¸newEndVnodeéƒ½åé€€ä¸€æ ¼<br>å®Œæˆè¿™äº›æ“ä½œå°±å˜æˆäº†ä¸‹å›¾è¿™æ ·ï¼š<br><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff5.jpg" alt="diff5"></p>
</li>
<li><p>oldStartVnode, newEndVnodeç›¸åŒçš„æƒ…å†µï¼š<br>è¿™ç§æƒ…å†µä¸‹æ„å‘³ç€å½“å‰ <code>æ—§Listsçš„StartIdxä½ç½®çš„å…ƒç´ </code>ï¼Œåœ¨<code>æ–°Listsä¸­</code>è¢«æŒªåˆ°äº†<code>EndIdxä½ç½®</code>ï¼ˆVnode moved rightï¼‰<br>åœ¨æ‰§è¡Œå®ŒpatchVnodeæ–¹æ³•ä¹‹åï¼Œåœ¨<code>çœŸå®DOMä¸­</code>æˆ‘ä»¬è¿˜è¦å°† <code>oldStart æ’åˆ° oldEndä¹‹å</code><br>oldStartVnodeå‰è¿›ä¸€æ ¼<br>newEndVnodeåé€€ä¸€æ ¼<br><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff6.jpg" alt="diff6"></p>
</li>
<li><p>oldEndVnode, newStartVnodeç›¸åŒçš„æƒ…å†µï¼š<br>è¿™ç§æƒ…å†µä¸‹æ„å‘³ç€å½“å‰ <code>æ—§Listsçš„EndIdxä½ç½®çš„å…ƒç´ </code>ï¼Œåœ¨<code>æ–°Listsä¸­</code>è¢«æŒªåˆ°äº†<code>StartIdxä½ç½®</code>ï¼ˆVnode moved leftï¼‰<br>åœ¨æ‰§è¡Œå®ŒpatchVnodeæ–¹æ³•ä¹‹åï¼Œåœ¨<code>çœŸå®DOMä¸­</code>æˆ‘ä»¬è¿˜è¦å°† <code>oldEnd æ’åˆ° oldStartä¹‹å‰</code><br>newStartVnodeå‰è¿›ä¸€æ ¼<br>oldEndVnodeåé€€ä¸€æ ¼<br><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff7.jpg" alt="diff7"></p>
</li>
</ol>
<p><code>ELSEï¼</code>å¦‚æœä¸Šé¢å››ç§æƒ…å†µéƒ½æ¯”å¯¹ä¸ä¸­ï¼Œä¹Ÿæ˜¯å°±å‡ºç°ä¸‹å›¾çš„æƒ…å†µï¼š<br><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff8.jpg" alt="diff8"></p>
<p>åˆ™ä¼šæ‰§è¡Œ <code>createKeyToOldIdx</code> æ–¹æ³•ï¼Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function createKeyToOldIdx (children, beginIdx, endIdx) &#123;</span><br><span class="line">  let i, key</span><br><span class="line">  const map = &#123;&#125;</span><br><span class="line">  for (i = beginIdx; i &lt;= endIdx; ++i) &#123;</span><br><span class="line">    key = children[i].key</span><br><span class="line">    if (isDef(key)) map[key] = i</span><br><span class="line">  &#125;</span><br><span class="line">  return map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿”å›ä¸€ä¸ª å“ˆå¸Œè¡¨(obj)ï¼Œå„é¡¹ é”®ä¸º vnode çš„ keyå±æ€§ï¼Œå€¼ä¸º vnode çš„ä¸‹æ ‡<br>å“ˆå¸Œè¡¨ä¸­çš„å†…å®¹åŒ…å«å¤„äº oldStart è‡³ oldEnd çš„ vnodeï¼Œå¤§æ¦‚é•¿è¿™æ ·ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  vnodeKeyA: 1,</span><br><span class="line">  vnodeKeyC: 2,</span><br><span class="line">  vnodeKeyD: 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ¥ç€ä»å“ˆå¸Œè¡¨ä¸­å¯»æ‰¾æ˜¯å¦æœ‰ä¸newStartVnode<code>ä¸€è‡´key</code>çš„oldVNodeèŠ‚ç‚¹<br>æ¥ç€çœ‹ä¸‹é¢ç¬¬5æ¡ï¼š</p>
<ol start="5">
<li>æˆ‘ä»¬åœ¨å“ˆå¸Œè¡¨ä¸­æ‰¾åˆ°äº†oldVnodeèŠ‚ç‚¹ï¼š<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnodeToMove = oldCh[idxInOld] // è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬æ‰¾åˆ°çš„`æ—§çš„vnode`</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>è¿™é‡Œè¿˜åˆ†äº†ä¸¤ç§æƒ…å†µ</p>
<ul>
<li>ä¸€ã€<code>å…‰æ¯”è¾ƒkeyï¼Œè‚¯å®šä¸è¶³ä»¥åˆ¤æ–­ä¸¤ä¸ªvnodeç›¸åŒ</code>ï¼Œæˆ‘ç€è¿™é‡Œå†è°ƒç”¨sameVnode(vnodeToMove, newStartVnode)æ–¹æ³•æ¥å¯¹æ¯”<br>å¦‚æœç›¸åŒï¼š<br>æ‰§è¡ŒpatchVnode<br>oldCh[idxInOld]èµ‹undefined // oldCh[idxInOld] = undefined ï¼Œæˆ‘ä»¬å·²ç»ç”¨vnodeToMoveä¿å­˜äº†ä¸€ä»½äº†<br>ç„¶ååœ¨<code>çœŸå®DOMä¸­</code>ï¼Œ<code>æŠŠvnodeToMoveæ’å…¥åˆ°oldStartä¹‹å‰</code><br>newStartVnodeéƒ½å‰è¿›ä¸€æ ¼<br>æ”¾ä»£ç æŠŠï¼š<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vnodeToMove = oldCh[idxInOld]</span><br><span class="line">if (sameVnode(vnodeToMove, newStartVnode)) &#123;</span><br><span class="line">  patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">  oldCh[idxInOld] = undefined</span><br><span class="line">  canMove &amp;&amp; nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)</span><br><span class="line">&#125; else &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff9.jpg" alt="diff9"></p>
<ul>
<li>äºŒã€keyç›¸åŒï¼Œä½†sameVnodeæ¯”è¾ƒå‡ºæ¥ä¸ç›¸åŒ<br>è¿™ç§æƒ…å†µä¸‹åˆ™è°ƒç”¨createElmåˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒç´ æ’åˆ°oldStartå‰é¢<br>newStartVnodeéƒ½å‰è¿›ä¸€æ ¼<br><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff10.jpg" alt="diff10"></li>
</ul>
<ol start="6">
<li><p>æˆ‘ä»¬åœ¨å“ˆå¸Œè¡¨ä¸­ï¼ï¼ï¼æ²¡æœ‰æ‰¾åˆ°oldVnodeï¼ï¼ï¼èŠ‚ç‚¹ï¼š<br>è¿™ç§æƒ…å†µä¸‹å’Œ 5 ä¸­çš„ç¬¬äºŒç§æƒ…å†µä¸€æ¨¡ä¸€æ ·<br>è°ƒç”¨createElmåˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒç´ æ’åˆ°oldStartå‰é¢<br>newStartVnodeéƒ½å‰è¿›ä¸€æ ¼</p>
</li>
<li><p>åˆ°äº†è¿™ä¸€æ­¥ï¼Œwhileå·²ç»å¾ªç¯å®Œæ¯•äº†ï¼Œæ¥ä¸‹æ¥è¦å¤„ç†æ–°æ—§Listé•¿çŸ­ä¸ç›¸åŒçš„æƒ…å†µ</p>
</li>
</ol>
<ul>
<li>ä¸€ã€oldStartIdx &gt; oldEndIdxï¼ŒoldStart è¶…è¿‡äº†oldEndï¼Œè¯´æ˜<code>æ–°Listæ¯”æ—§Listsé•¿</code><br>æˆ‘ä»¬éœ€è¦æŠŠæ²¡éå†åˆ°çš„vnodeé€‰å‡ºæ¥ï¼Œç”¨refElmå­˜ä¸€ä¸‹ï¼Œç„¶åå•Šï¼Œä½¿ç”¨addVnodesæ‰¹é‡è°ƒç”¨åˆ›å»ºï¼ˆcreateElmï¼‰æŠŠè¿™äº›vnodeåŠ åˆ°çœŸå®DOMä¸­<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">  refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm</span><br><span class="line">  addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff11.jpg" alt="diff11"></p>
<ul>
<li>äºŒã€newStartIdx &gt; newEndIdxï¼Œè¯´æ˜<code>æ—§Listæ¯”æ–°Listsé•¿</code><br>æˆ‘ä»¬è°ƒç”¨removeVnodesæ–¹æ³•ï¼Œå‚æ•°åŒ…å«oldStartIdx ä¸ oldEndIdxï¼ŒæŠŠå¤šä½™çš„åˆ æ‰<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if&#123;</span><br><span class="line">  // code...</span><br><span class="line">&#125;</span><br><span class="line">else if (newStartIdx &gt; newEndIdx) &#123;</span><br><span class="line">  removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/hbxywdk/hexo-blog/master/assets/2019-04/diff12.jpg" alt="diff12"></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><blockquote>
<p><a href="https://blog.csdn.net/u013929284/article/details/56483035" target="_blank" rel="noopener">é«˜é¢‘domæ“ä½œå’Œé¡µé¢æ€§èƒ½ä¼˜åŒ–æ¢ç´¢</a><br><a href="https://calendar.perfplanet.com/2013/diff/" target="_blank" rel="noopener">Reactâ€™s diff algorithm</a><br><a href="https://github.com/answershuto/learnVue" target="_blank" rel="noopener">https://github.com/answershuto/learnVue</a></p>
</blockquote>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-05-06</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Vue/" title="Vue">Vue </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2019/05/06/å­¦ä¹ Vueæºç 9-æµ…è°ˆVueä¸­çš„Diffç®—æ³•/,DK'S BLOG,å­¦ä¹ Vueæºç 9-æµ…è°ˆVueä¸­çš„Diffç®—æ³•,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/05/07/æ’¸ä¸€ä¸ªç®€æ˜“å¯Œæ–‡æœ¬ç¼–è¾‘å™¨/" title="æ’¸ä¸€ä¸ªç®€æ˜“å¯Œæ–‡æœ¬ç¼–è¾‘å™¨">ä¸Šä¸€ç¯‡</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/05/06/å­¦ä¹ Vueæºç 8-vm-renderä¸vm-update/" title="å­¦ä¹ Vueæºç 8-vm._renderä¸vm._update">ä¸‹ä¸€ç¯‡</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>