<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="hbxywdk,hbxywdk@gmail.com"><title>Vuex源码分析2 · DK'S BLOG</title><meta name="description" content="接下来就是实例化一个 Vuex.Store：12345678910const store = new Vuex.Store(&amp;#123;  state: &amp;#123;    count: 0  &amp;#125;,  mutations: &amp;#123;    increment (state) &amp;#123"><meta name="keywords" content="blog,FE,HTML,CSS,Javascript,Vue,Nuxt"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">DK'S BLOG</a></h3><div class="description"><p>Judge not from appearances.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/DKWang8"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/3136805851"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/hbxywdk"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/de.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Vuex源码分析2</a></h3></div><div class="post-content"><p>接下来就是实例化一个 Vuex.Store：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const store = new Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    count: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment (state) &#123;</span><br><span class="line">      state.count++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><p>Store的代码位于 src/store.js 中，先看 Store 的构造函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">constructor (options = &#123;&#125;) &#123;</span><br><span class="line">  // code... 省略</span><br><span class="line"></span><br><span class="line">  const &#123;</span><br><span class="line">    plugins = [], // 传入的插件配置 https://vuex.vuejs.org/zh/guide/plugins.html</span><br><span class="line">    strict = false // 是否开启严格模式 https://vuex.vuejs.org/zh/guide/strict.html</span><br><span class="line">  &#125; = options</span><br><span class="line"></span><br><span class="line">  /* 初始化内部状态 */</span><br><span class="line"></span><br><span class="line">  this._committing = false</span><br><span class="line">  // actions</span><br><span class="line">  this._actions = Object.create(null)</span><br><span class="line">  // 存放 actions 的订阅者</span><br><span class="line">  this._actionSubscribers = []</span><br><span class="line">  // mutations</span><br><span class="line">  this._mutations = Object.create(null)</span><br><span class="line">  // getters</span><br><span class="line">  this._wrappedGetters = Object.create(null)</span><br><span class="line">  // 模块收集</span><br><span class="line">  this._modules = new ModuleCollection(options)</span><br><span class="line">  // 模块命名空间 Map</span><br><span class="line">  this._modulesNamespaceMap = Object.create(null)</span><br><span class="line">  // 存放订阅者</span><br><span class="line">  this._subscribers = []</span><br><span class="line">  // 用以实现 Vuex.Store.watch 方法的Vue实例</span><br><span class="line">  this._watcherVM = new Vue()</span><br><span class="line"></span><br><span class="line">  // 绑定 commit 与 dispacth 的指向</span><br><span class="line">  const store = this</span><br><span class="line">  const &#123; dispatch, commit &#125; = this</span><br><span class="line">  this.dispatch = function boundDispatch (type, payload) &#123;</span><br><span class="line">    return dispatch.call(store, type, payload)</span><br><span class="line">  &#125;</span><br><span class="line">  this.commit = function boundCommit (type, payload, options) &#123;</span><br><span class="line">    return commit.call(store, type, payload, options)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 严格模式下，任何 mutation 处理函数以外修改 Vuex state 都会抛出错误。https://vuex.vuejs.org/zh/api/#strict</span><br><span class="line">  this.strict = strict</span><br><span class="line"></span><br><span class="line">  // 根 state</span><br><span class="line">  const state = this._modules.root.state</span><br><span class="line"></span><br><span class="line">  // 初始化根模块，同时递归注册所有子模块，并收集所有模块的 getters 存放到 this._wrappedGetters 中 </span><br><span class="line">  installModule(this, state, [], this._modules.root)</span><br><span class="line"></span><br><span class="line">  // 初始化 store 的 vm，负责反应，同时将 _wrappedGetters 注册为计算属性）</span><br><span class="line">  resetStoreVM(this, state)</span><br><span class="line"></span><br><span class="line">  // plugins 应用插件</span><br><span class="line">  plugins.forEach(plugin =&gt; plugin(this))</span><br><span class="line"></span><br><span class="line">  // devtool 插件相关</span><br><span class="line">  const useDevtools = options.devtools !== undefined ? options.devtools : Vue.config.devtools</span><br><span class="line">  if (useDevtools) &#123;</span><br><span class="line">    devtoolPlugin(this)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>构造函数中主要是一些内部值的初始化与一些初始化方法的执行，我们按照构造函数的执行顺序由上到下分析。</p>
<h4 id="ModuleCollection"><a href="#ModuleCollection" class="headerlink" title="ModuleCollection"></a>ModuleCollection</h4><p>首先是这一句：<code>this._modules = new ModuleCollection(options)</code>，这里实例化了 ModuleCollection，用于模块收集，并处理成 Vuex 所需的数据结构。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">export default class ModuleCollection &#123;</span><br><span class="line">  constructor (rawRootModule) &#123;</span><br><span class="line">    // 使用 Vuex.Store 的 options 注册根模块</span><br><span class="line">    this.register([], rawRootModule, false)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get (path) &#123;</span><br><span class="line">    return path.reduce((module, key) =&gt; &#123;</span><br><span class="line">      return module.getChild(key) // 获取名为入参 key 的子模块</span><br><span class="line">    &#125;, this.root)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getNamespace (path) &#123;</span><br><span class="line">    let module = this.root</span><br><span class="line">    return path.reduce((namespace, key) =&gt; &#123;</span><br><span class="line">      module = module.getChild(key)</span><br><span class="line">      return namespace + (module.namespaced ? key + &apos;/&apos; : &apos;&apos;)</span><br><span class="line">    &#125;, &apos;&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 更新</span><br><span class="line">  update (rawRootModule) &#123;</span><br><span class="line">    update([], this.root, rawRootModule)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 注册</span><br><span class="line">  register (path, rawModule, runtime = true) &#123;</span><br><span class="line">    if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">      assertRawModule(path, rawModule)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const newModule = new Module(rawModule, runtime)</span><br><span class="line"></span><br><span class="line">    if (path.length === 0) &#123;</span><br><span class="line">      this.root = newModule</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      const parent = this.get(path.slice(0, -1))</span><br><span class="line">      // 调用 Module 的 addChild 添加子模块</span><br><span class="line">      parent.addChild(path[path.length - 1], newModule)</span><br><span class="line">    &#125;</span><br><span class="line">    if (rawModule.modules) &#123;</span><br><span class="line">      forEachValue(rawModule.modules, (rawChildModule, key) =&gt; &#123;</span><br><span class="line">        this.register(path.concat(key), rawChildModule, runtime)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unregister (path) &#123;</span><br><span class="line">    const parent = this.get(path.slice(0, -1))</span><br><span class="line">    const key = path[path.length - 1]</span><br><span class="line">    if (!parent.getChild(key).runtime) return</span><br><span class="line"></span><br><span class="line">    parent.removeChild(key)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ModuleCollection 的构造函数中从<code>根</code>开始调用 <code>this.register([], rawRootModule, false)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// 注册</span><br><span class="line">register (path, rawModule, runtime = true) &#123;</span><br><span class="line">  if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">    assertRawModule(path, rawModule)</span><br><span class="line">  &#125;</span><br><span class="line">  // Module 是 Store 的基础数据结构！</span><br><span class="line">  const newModule = new Module(rawModule, runtime)</span><br><span class="line"></span><br><span class="line">  // path = []</span><br><span class="line">  if (path.length === 0) &#123;</span><br><span class="line">    // 首次注册，将 this.root 设置为 newModule</span><br><span class="line">    this.root = newModule</span><br><span class="line"></span><br><span class="line">  // 子模块走这里（path = [&apos;modulesName&apos;]）</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 获取给 路径数组的最后一个元素，也就是当前 module 的 父亲 parent 添加 child</span><br><span class="line">    const parent = this.get(path.slice(0, -1))</span><br><span class="line">    // 调用 Module 的 addChild 添加子模块</span><br><span class="line">    parent.addChild(path[path.length - 1], newModule)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 如果用户有使用嵌套模块（modules），则遍历所有模块，为每个模块都执行 this.register 注册。</span><br><span class="line">  if (rawModule.modules) &#123;</span><br><span class="line">    forEachValue(rawModule.modules, (rawChildModule, key) =&gt; &#123;</span><br><span class="line">      // args：路径数组、对应module、是否是运行时</span><br><span class="line">      this.register(path.concat(key), rawChildModule, runtime)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从<code>根</code>开始调用 register 会实例化一个 Module 对象 <code>new Module(rawModule, runtime)</code> 并将其赋值给 <code>this.root</code>。<br>这里的 <code>Module 对象 (src/module/module.js) 是 Store 的基础数据结构</code>，如果使用了 module 功能，则会递归注册所有子module。<br>register 方法的第一个参数是路径数组，举几个例子：</p>
<ol>
<li>如果未使用 module，则 path 为[]，代码不会走到这里，一次注册就结束了</li>
<li>如果有一级 module，则 path 为[‘modulesName’]</li>
<li>如果有两级 module，则 path 为[‘modulesName’, grandsonModulesName]</li>
<li>依次类推 。。。。。。</li>
</ol>
<p>对于使用了 modules 子模块的则会调用 <code>父 Module 的 addChild 方法</code>添加到 父 Module 的 _children 中，最终构造出<code>以 Module 为基础结构的树状结构</code>。</p>
<h4 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h4><p>Module 是 Store 的基础数据结构，代码不多，这里直接带注释全部贴出来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">// Store 的基础数据结构，包含一些属性与方法</span><br><span class="line">export default class Module &#123;</span><br><span class="line">  constructor (rawModule, runtime) &#123;</span><br><span class="line">    this.runtime = runtime</span><br><span class="line">    // 储存一些子模块</span><br><span class="line">    this._children = Object.create(null)</span><br><span class="line">    // 储存 rawModule</span><br><span class="line">    this._rawModule = rawModule</span><br><span class="line">    // 取出 rawModule 的 state</span><br><span class="line">    const rawState = rawModule.state</span><br><span class="line">    // 如果 rawState 是函数则执行，赋值 this.state 为函数返回值，否则赋值为 rawState 或 &#123;&#125;</span><br><span class="line">    this.state = (typeof rawState === &apos;function&apos; ? rawState() : rawState) || &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 获取是否开启了 namespaced</span><br><span class="line">  get namespaced () &#123;</span><br><span class="line">    return !!this._rawModule.namespaced</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 添加子模块</span><br><span class="line">  addChild (key, module) &#123;</span><br><span class="line">    this._children[key] = module</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 移除子模块</span><br><span class="line">  removeChild (key) &#123;</span><br><span class="line">    delete this._children[key]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 获取子模块</span><br><span class="line">  getChild (key) &#123;</span><br><span class="line">    return this._children[key]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 更新方法，用传入的 rawModule 的 namespaced、actions、mutations、getters替换原有的</span><br><span class="line">  update (rawModule) &#123;</span><br><span class="line">    // 更新 namespaced</span><br><span class="line">    this._rawModule.namespaced = rawModule.namespaced</span><br><span class="line">    // 更新 actions</span><br><span class="line">    if (rawModule.actions) &#123;</span><br><span class="line">      this._rawModule.actions = rawModule.actions</span><br><span class="line">    &#125;</span><br><span class="line">    // 更新 mutations</span><br><span class="line">    if (rawModule.mutations) &#123;</span><br><span class="line">      this._rawModule.mutations = rawModule.mutations</span><br><span class="line">    &#125;</span><br><span class="line">    // 更新 getters</span><br><span class="line">    if (rawModule.getters) &#123;</span><br><span class="line">      this._rawModule.getters = rawModule.getters</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 取出 this._children 的每个子项，以其为参数传入 fn 执行</span><br><span class="line">  forEachChild (fn) &#123;</span><br><span class="line">    forEachValue(this._children, fn)</span><br><span class="line">  &#125;</span><br><span class="line">  // 取出 Getter 的每个子项，以其为参数传入 fn 执行</span><br><span class="line">  forEachGetter (fn) &#123;</span><br><span class="line">    if (this._rawModule.getters) &#123;</span><br><span class="line">      forEachValue(this._rawModule.getters, fn)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  // 取出 Action 的每个子项，以其为参数传入 fn 执行</span><br><span class="line">  forEachAction (fn) &#123;</span><br><span class="line">    if (this._rawModule.actions) &#123;</span><br><span class="line">      forEachValue(this._rawModule.actions, fn)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  // 取出 Mutation 的每个子项，以其为参数传入 fn 执行</span><br><span class="line">  forEachMutation (fn) &#123;</span><br><span class="line">    if (this._rawModule.mutations) &#123;</span><br><span class="line">      forEachValue(this._rawModule.mutations, fn)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="继续看构造函数"><a href="#继续看构造函数" class="headerlink" title="继续看构造函数"></a>继续看构造函数</h4><h5 id="赋值-this-watcherVM-为一个-Vue-实例，用以实现-Vuex-Store-watch-方法。"><a href="#赋值-this-watcherVM-为一个-Vue-实例，用以实现-Vuex-Store-watch-方法。" class="headerlink" title="赋值 this._watcherVM 为一个 Vue 实例，用以实现 Vuex.Store.watch 方法。"></a>赋值 this._watcherVM 为一个 Vue 实例，用以实现 Vuex.Store.watch 方法。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this._watcherVM = new Vue()</span><br></pre></td></tr></table></figure>
<p>watch 方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Doc：https://vuex.vuejs.org/zh/api/#watch</span><br><span class="line">watch (getter, cb, options) &#123;</span><br><span class="line">  if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">    assert(typeof getter === &apos;function&apos;, `store.watch only accepts a function.`)</span><br><span class="line">  &#125;</span><br><span class="line">  return this._watcherVM.$watch(() =&gt; getter(this.state, this.getters), cb, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="绑定-commit-与-dispacth-的指向"><a href="#绑定-commit-与-dispacth-的指向" class="headerlink" title="绑定 commit 与 dispacth 的指向"></a>绑定 commit 与 dispacth 的指向</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const store = this</span><br><span class="line">const &#123; dispatch, commit &#125; = this</span><br><span class="line">this.dispatch = function boundDispatch (type, payload) &#123;</span><br><span class="line">  return dispatch.call(store, type, payload)</span><br><span class="line">&#125;</span><br><span class="line">this.commit = function boundCommit (type, payload, options) &#123;</span><br><span class="line">  return commit.call(store, type, payload, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="调用-installModule-与-resetStoreVM-方法"><a href="#调用-installModule-与-resetStoreVM-方法" class="headerlink" title="调用 installModule 与 resetStoreVM 方法"></a>调用 installModule 与 resetStoreVM 方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 根 state</span><br><span class="line">const state = this._modules.root.state</span><br><span class="line"></span><br><span class="line">// 初始化根模块，同时递归注册所有子模块，并收集所有模块的 getters 存放到 this._wrappedGetters 中 </span><br><span class="line">installModule(this, state, [], this._modules.root)</span><br><span class="line"></span><br><span class="line">// 以当前的 state 重置数据，同时将 _wrappedGetters 注册为计算属性</span><br><span class="line">resetStoreVM(this, state)</span><br></pre></td></tr></table></figure>
<h5 id="插件相关"><a href="#插件相关" class="headerlink" title="插件相关"></a>插件相关</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// plugins 应用插件</span><br><span class="line">plugins.forEach(plugin =&gt; plugin(this))</span><br><span class="line"></span><br><span class="line">// devtool 插件相关</span><br><span class="line">const useDevtools = options.devtools !== undefined ? options.devtools : Vue.config.devtools</span><br><span class="line">if (useDevtools) &#123;</span><br><span class="line">  devtoolPlugin(this)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-08-01</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Vue/" title="Vue">Vue </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2019/08/01/Vuex源码分析2/,DK'S BLOG,Vuex源码分析2,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/08/16/canvas压缩jpg丢失exif/" title="使用Canvas压缩Jpg图片丢失Exif信息问题">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/07/26/Vuex源码分析1/" title="Vuex源码分析1">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>