<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="hbxywdk,hbxywdk@gmail.com"><title>学习Vue源码13-Keep-Alive · DK'S BLOG</title><meta name="description" content="keep-alive组件本身就是一个组件，其代码位于 core/components/keep-alive.js 中:1234567891011121314151617181920212223242526272829export default &amp;#123;  name: &amp;apos;keep-al"><meta name="keywords" content="blog,FE,HTML,CSS,Javascript,Vue,Nuxt"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">DK'S BLOG</a></h3><div class="description"><p>Judge not from appearances.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/DKWang8"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/3136805851"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/hbxywdk"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/de.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>学习Vue源码13-Keep-Alive</a></h3></div><div class="post-content"><p>keep-alive组件本身就是一个组件，其代码位于 <code>core/components/keep-alive.js</code> 中:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;</span><br><span class="line">  name: &apos;keep-alive&apos;,</span><br><span class="line">  abstract: true,</span><br><span class="line"></span><br><span class="line">  props: &#123;</span><br><span class="line">    include: patternTypes, // 字符串或正则表达式。只有名称匹配的组件会被缓存。</span><br><span class="line">    exclude: patternTypes, // 字符串或正则表达式。任何名称匹配的组件都不会被缓存。</span><br><span class="line">    max: [String, Number] // 数字。最多可以缓存多少组件实例。</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  // created</span><br><span class="line">  created () &#123;</span><br><span class="line">    // code...</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  // mounted</span><br><span class="line">  mounted () &#123;</span><br><span class="line">    // code...</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  // destroyed 时销毁虽有组件</span><br><span class="line">  destroyed () &#123;</span><br><span class="line">    // code...</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    // code...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先，定义了三个 props，对应<a href="https://cn.vuejs.org/v2/api/#keep-alive" target="_blank" rel="noopener">keep-alive文档</a> 中的三个可传参数。</p>
<p>接下来，按着 vue 生命周期来看，由于 keep-alive 组件使用了 render 方法，则这里的生命周期为：created -&gt; render -&gt; mounted -&gt; destroyed。</p>
<h4 id="created"><a href="#created" class="headerlink" title="created"></a>created</h4><p>这一步比较简单，定义了一个空对象 cache，一个空数组 key 用来存放要缓存的内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">created () &#123;</span><br><span class="line">  this.cache = Object.create(null)</span><br><span class="line">  this.keys = []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="render"><a href="#render" class="headerlink" title="render"></a>render</h4><p>接下来是 render 函数，这一步代码比较多，也是 keep-alive 的核心内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">render () &#123;</span><br><span class="line">  const slot = this.$slots.default // 所有slots数组</span><br><span class="line">  // 获取 slots 中第一个有效子组件</span><br><span class="line">  const vnode: VNode = getFirstComponentChild(slot) </span><br><span class="line">  const componentOptions: ?VNodeComponentOptions = vnode &amp;&amp; vnode.componentOptions // vnode 的配置项</span><br><span class="line">  if (componentOptions) &#123;</span><br><span class="line">    // check pattern</span><br><span class="line">    // 组件名，没有组件名就返回 tag 名</span><br><span class="line">    const name: ?string = getComponentName(componentOptions)</span><br><span class="line">    const &#123; include, exclude &#125; = this</span><br><span class="line">    // 不在 included 或者说 在 excluded 中，则是不缓存的组件，直接返回 vnode。</span><br><span class="line">    if (</span><br><span class="line">      // not included</span><br><span class="line">      (include &amp;&amp; (!name || !matches(include, name))) ||</span><br><span class="line">      // excluded</span><br><span class="line">      (exclude &amp;&amp; name &amp;&amp; matches(exclude, name))</span><br><span class="line">    ) &#123;</span><br><span class="line">      return vnode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const &#123; cache, keys &#125; = this</span><br><span class="line">    // vnode 有 key 则赋值为 key，没 key 则赋一个 key，这个 key 用于缓存组件</span><br><span class="line">    const key: ?string = vnode.key == null</span><br><span class="line">      // same constructor may get registered as different local components</span><br><span class="line">      // so cid alone is not enough (#3269)</span><br><span class="line">      ? componentOptions.Ctor.cid + (componentOptions.tag ? `::$&#123;componentOptions.tag&#125;` : &apos;&apos;)</span><br><span class="line">      : vnode.key</span><br><span class="line"></span><br><span class="line">    // 已缓存过，直接取缓存中的 componentInstance 给 vnode</span><br><span class="line">    if (cache[key]) &#123;</span><br><span class="line">      vnode.componentInstance = cache[key].componentInstance</span><br><span class="line">      // make current key freshest</span><br><span class="line">      // 移除缓存 key，之后重新添加，使 key 保持最新</span><br><span class="line">      remove(keys, key)</span><br><span class="line">      keys.push(key)</span><br><span class="line">    // 未缓存过，添加缓存</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      cache[key] = vnode</span><br><span class="line">      keys.push(key)</span><br><span class="line">      // prune oldest entry</span><br><span class="line">      // 最大缓存组件</span><br><span class="line">      if (this.max &amp;&amp; keys.length &gt; parseInt(this.max)) &#123;</span><br><span class="line">        pruneCacheEntry(cache, keys[0], keys, this._vnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // keepAlive 标记</span><br><span class="line">    vnode.data.keepAlive = true</span><br><span class="line">  &#125;</span><br><span class="line">  return vnode || (slot &amp;&amp; slot[0])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>首先，获取第一个子组件，接着会检测是否存在于 included 和 excluded 中，如果不在 included 或者说在 excluded 中，则是不缓存的组件，就直接返回 vnode 渲染。</li>
<li>接着会定义一个 key 用于组件的缓存。</li>
<li>如果缓存中存在，则直接取缓存中的 componentInstance 赋给 vnode（keep-alive的第一个slot组件） 的 componentInstance，最后返回让 render 函数渲染。</li>
<li>如果缓存中不存在，则将其添加进缓存，并做最大缓存组件数量的处理，最后添加 keep-alive 标记，并返回 vnode。</li>
</ol>
<h4 id="mounted"><a href="#mounted" class="headerlink" title="mounted"></a>mounted</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mounted () &#123;</span><br><span class="line">  // 监听 include，变化后执行 pruneCache</span><br><span class="line">  this.$watch(&apos;include&apos;, val =&gt; &#123;</span><br><span class="line">    pruneCache(this, name =&gt; matches(val, name))</span><br><span class="line">  &#125;)</span><br><span class="line">  // 监听 exclude，变化后执行 pruneCache</span><br><span class="line">  this.$watch(&apos;exclude&apos;, val =&gt; &#123;</span><br><span class="line">    pruneCache(this, name =&gt; !matches(val, name))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>在 mounted 中使用 $watch 分别对 include 与 exclude 两个 props 进行了监听，一旦变化则执行对应函数 pruneCache。<br>注意：include 与 exclude 的函数参数是有区别的，一个是 name =&gt; matches(val, name) 一个是 name =&gt; !matches(val, name)。</p>
<h5 id="pruneCache"><a href="#pruneCache" class="headerlink" title="pruneCache:"></a>pruneCache:</h5><p>遍历 cache ，这里分两种情况：<br>一种是 include 的，当新的 include 改变，移除了某个组件，则会调用 pruneCacheEntry 函数清除该缓存。<br>另一种是 exclude 的，当新的 exclude 改变，添加了某个忽略，则也会调用 pruneCacheEntry 函数清除该缓存。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * </span><br><span class="line"> * @param &#123;any&#125; keepAliveInstance keep-alive实例</span><br><span class="line"> * @param &#123;Function&#125; filter 返回是否匹配上的函数</span><br><span class="line"> */</span><br><span class="line">function pruneCache (keepAliveInstance: any, filter: Function) &#123;</span><br><span class="line">  // cache（create中创建的一个空对象）</span><br><span class="line">  // keys（create中创建的一个空数组）</span><br><span class="line">  // _vnode（keep-alive组件的_vnode属性）</span><br><span class="line">  const &#123; cache, keys, _vnode &#125; = keepAliveInstance</span><br><span class="line"></span><br><span class="line">  // 遍历缓存</span><br><span class="line">  for (const key in cache) &#123;</span><br><span class="line">    const cachedNode: ?VNode = cache[key]</span><br><span class="line">    if (cachedNode) &#123;</span><br><span class="line">      // 当前遍历组件名称</span><br><span class="line">      const name: ?string = getComponentName(cachedNode.componentOptions)</span><br><span class="line">      if (name &amp;&amp; !filter(name)) &#123;</span><br><span class="line">        pruneCacheEntry(cache, key, keys, _vnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="matches"><a href="#matches" class="headerlink" title="matches"></a>matches</h5><p>matches 函数用来匹配 pattern 中是否有 name，有返回 true，无返回 false。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function matches (pattern: string | RegExp | Array&lt;string&gt;, name: string): boolean &#123;</span><br><span class="line">  if (Array.isArray(pattern)) &#123;</span><br><span class="line">    return pattern.indexOf(name) &gt; -1</span><br><span class="line">  &#125; else if (typeof pattern === &apos;string&apos;) &#123;</span><br><span class="line">    return pattern.split(&apos;,&apos;).indexOf(name) &gt; -1</span><br><span class="line">  &#125; else if (isRegExp(pattern)) &#123;</span><br><span class="line">    return pattern.test(name)</span><br><span class="line">  &#125;</span><br><span class="line">  /* istanbul ignore next */</span><br><span class="line">  return false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="pruneCacheEntry"><a href="#pruneCacheEntry" class="headerlink" title="pruneCacheEntry"></a>pruneCacheEntry</h5><p>销毁实例，并从 cache 中移除<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function pruneCacheEntry (</span><br><span class="line">  cache: VNodeCache,</span><br><span class="line">  key: string,</span><br><span class="line">  keys: Array&lt;string&gt;,</span><br><span class="line">  current?: VNode</span><br><span class="line">) &#123;</span><br><span class="line">  const cached = cache[key]</span><br><span class="line">  if (cached &amp;&amp; (!current || cached.tag !== current.tag)) &#123;</span><br><span class="line">    cached.componentInstance.$destroy()</span><br><span class="line">  &#125;</span><br><span class="line">  cache[key] = null</span><br><span class="line">  remove(keys, key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="destoryed"><a href="#destoryed" class="headerlink" title="destoryed"></a>destoryed</h4><p>最后是 destoryed，这个没啥说的，keep-alive 组件销毁的时候，清空所有缓存过的内容，完事。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">destroyed () &#123;</span><br><span class="line">  for (const key in this.cache) &#123;</span><br><span class="line">    pruneCacheEntry(this.cache, key, this.keys)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-07-02</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Vue/" title="Vue">Vue </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2019/07/02/学习Vue源码13-Keep-Alive/,DK'S BLOG,学习Vue源码13-Keep-Alive,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/07/12/Axios源码1/" title="Axios源码1-入口文件">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/05/16/Koa-2/" title="Koa源码2">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>