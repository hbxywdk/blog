<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="hbxywdk,hbxywdk@gmail.com"><title>Vue-router源码分析1 · DK'S BLOG</title><meta name="description" content="Vue-router 版本 3.0.7
目录结构123456789101112-- lib  -- components // 存放 &amp;lt;router-view&amp;gt; 与 &amp;lt;router-link&amp;gt; 组件  -- history // 存放几种路由方式文件    -- base.j"><meta name="keywords" content="blog,FE,HTML,CSS,Javascript,Vue,Nuxt"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">DK'S BLOG</a></h3><div class="description"><p>Judge not from appearances.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/DKWang8"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/3136805851"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/hbxywdk"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/de.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Vue-router源码分析1</a></h3></div><div class="post-content"><p>Vue-router 版本 3.0.7</p>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-- lib</span><br><span class="line">  -- components // 存放 &lt;router-view&gt; 与 &lt;router-link&gt; 组件</span><br><span class="line">  -- history // 存放几种路由方式文件</span><br><span class="line">    -- base.js // 所有模式共有部分</span><br><span class="line">    -- hash.js // hash 模式</span><br><span class="line">    -- html5.js // h5 history 模式</span><br><span class="line">    ......</span><br><span class="line">  -- util // 工具函数</span><br><span class="line">  -- create-matcher.js // </span><br><span class="line">  -- create-route-map.js // </span><br><span class="line">  -- index.js // 入口文件</span><br><span class="line">  -- install.js // 用于 Vue.use()</span><br></pre></td></tr></table></figure>
<h4 id="Vue-router-在模块化项目中的常规使用"><a href="#Vue-router-在模块化项目中的常规使用" class="headerlink" title="Vue-router 在模块化项目中的常规使用"></a>Vue-router 在模块化项目中的常规使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import Vue from &apos;vue&apos;</span><br><span class="line">import VueRouter from &apos;vue-router&apos;</span><br><span class="line"></span><br><span class="line">// 调用 Vue.use()，在模块化项目中必须手动调用，在常规项目中（script 标签引入） Vue 会主动调用 use。</span><br><span class="line">Vue.use(VueRouter)</span><br><span class="line"></span><br><span class="line">// 创建路由实例</span><br><span class="line">var router = new VueRouter(&#123;</span><br><span class="line">  mode: &apos;hash&apos;, // 路由模式</span><br><span class="line">  routes: routes // 路由配置</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 创建 Vue 实例</span><br><span class="line">new Vue(&#123;</span><br><span class="line">  el: &apos;#app&apos;,</span><br><span class="line">  render: h =&gt; h(App),</span><br><span class="line">  router,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>我们按照 Vue-router 的使用一步步来看。</p>
<h4 id="Vue-use-VueRouter"><a href="#Vue-use-VueRouter" class="headerlink" title="Vue.use(VueRouter)"></a>Vue.use(VueRouter)</h4><p>Vue.use 方法会调用插件的 install 方法，Vue-router 的 install 方法位于 <code>src/install.js</code> 文件中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">export let _Vue</span><br><span class="line">export function install (Vue) &#123;</span><br><span class="line">  if (install.installed &amp;&amp; _Vue === Vue) return // 已被安装 return</span><br><span class="line">  install.installed = true</span><br><span class="line">  _Vue = Vue</span><br><span class="line">  const isDef = v =&gt; v !== undefined</span><br><span class="line">  const registerInstance = (vm, callVal) =&gt; &#123;</span><br><span class="line">    let i = vm.$options._parentVnode</span><br><span class="line">    if (isDef(i) &amp;&amp; isDef(i = i.data) &amp;&amp; isDef(i = i.registerRouteInstance)) &#123;</span><br><span class="line">      i(vm, callVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 全局注入 beforeCreate 与 destroyed </span><br><span class="line">  Vue.mixin(&#123;</span><br><span class="line">    beforeCreate () &#123;</span><br><span class="line">      // 这里判断 this.$options.router 是否存在，我们在 new Vue() 时传入 router，vue就会把 router 挂载到 this.$options 上，这是 new Vue() 需要传入 router 的原因</span><br><span class="line">      if (isDef(this.$options.router)) &#123;</span><br><span class="line">        this._routerRoot = this</span><br><span class="line">        this._router = this.$options.router</span><br><span class="line">        this._router.init(this)</span><br><span class="line">        Vue.util.defineReactive(this, &apos;_route&apos;, this._router.history.current)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this</span><br><span class="line">      &#125;</span><br><span class="line">      registerInstance(this, this)</span><br><span class="line">    &#125;,</span><br><span class="line">    destroyed () &#123;</span><br><span class="line">      registerInstance(this)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  // 在 Vue 的原型上定义 $router，使之可以在 Vue 组件中以 this.$router 调用</span><br><span class="line">  Object.defineProperty(Vue.prototype, &apos;$router&apos;, &#123;</span><br><span class="line">    get () &#123; return this._routerRoot._router &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  // 在 Vue 的原型上定义 $route，使之可以在 Vue 组件中以 this.$route 调用</span><br><span class="line">  Object.defineProperty(Vue.prototype, &apos;$route&apos;, &#123;</span><br><span class="line">    get () &#123; return this._routerRoot._route &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  // 全局注册 &lt;router-view&gt; 与 &lt;router-link&gt; 组件</span><br><span class="line">  Vue.component(&apos;RouterView&apos;, View)</span><br><span class="line">  Vue.component(&apos;RouterLink&apos;, Link)</span><br><span class="line"></span><br><span class="line">  const strats = Vue.config.optionMergeStrategies</span><br><span class="line">  // use the same hook merging strategy for route hooks</span><br><span class="line">  strats.beforeRouteEnter = strats.beforeRouteLeave = strats.beforeRouteUpdate = strats.created</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先使用 Vue.mixin 全局混入了 <code>beforeCreate</code> 与 <code>destroyed</code> 两个周期函数。<br>接着在 Vue 的原型上定义 <code>$router</code> 和 <code>$route</code>，我们就可以在 Vue 组件中访问到 <code>this.$router</code> 和 <code>this.router</code>。<br>最后使用 Vue.component 全局注册 <code>&lt;router-view&gt;</code> 与 <code>&lt;router-link&gt;</code> 组件。</p>
<h4 id="new-VueRouter"><a href="#new-VueRouter" class="headerlink" title="new VueRouter()"></a>new VueRouter()</h4><p>VueRouter 的构造函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">constructor (options: RouterOptions = &#123;&#125;) &#123;</span><br><span class="line">  this.app = null</span><br><span class="line">  this.apps = []</span><br><span class="line">  this.options = options</span><br><span class="line">  this.beforeHooks = []</span><br><span class="line">  this.resolveHooks = []</span><br><span class="line">  this.afterHooks = []</span><br><span class="line">  this.matcher = createMatcher(options.routes || [], this)</span><br><span class="line"></span><br><span class="line">  let mode = options.mode || &apos;hash&apos;</span><br><span class="line">  this.fallback = mode === &apos;history&apos; &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false</span><br><span class="line">  if (this.fallback) &#123;</span><br><span class="line">    mode = &apos;hash&apos;</span><br><span class="line">  &#125;</span><br><span class="line">  if (!inBrowser) &#123;</span><br><span class="line">    mode = &apos;abstract&apos;</span><br><span class="line">  &#125;</span><br><span class="line">  this.mode = mode</span><br><span class="line"></span><br><span class="line">  // 根据模式的不同实例化不同的 this.history</span><br><span class="line">  switch (mode) &#123;</span><br><span class="line">    case &apos;history&apos;:</span><br><span class="line">      this.history = new HTML5History(this, options.base)</span><br><span class="line">      break</span><br><span class="line">    case &apos;hash&apos;:</span><br><span class="line">      this.history = new HashHistory(this, options.base, this.fallback)</span><br><span class="line">      break</span><br><span class="line">    case &apos;abstract&apos;:</span><br><span class="line">      this.history = new AbstractHistory(this, options.base)</span><br><span class="line">      break</span><br><span class="line">    default:</span><br><span class="line">      if (process.env.NODE_ENV !== &apos;production&apos;) &#123;</span><br><span class="line">        assert(false, `invalid mode: $&#123;mode&#125;`)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>VueRouter的构造函数中会根据模式的不同实例化不同的 this.history，包括 <code>hash</code>、<code>history</code>、<code>abstract</code> 三种，对应 <code>HashHistory</code>、<code>HTML5History</code>、<code>AbstractHistory</code> 三个类，<br>这三个类分别实现了自己的 <code>onReady</code>、<code>onError</code>、<code>push</code>、<code>replace</code>、<code>go</code>、<code>getCurrentLocation</code> 等方法，VueRouter 类向外暴露的同名方法实际上就是调用了上面三个类自己实现的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">onReady (cb: Function, errorCb?: Function) &#123;</span><br><span class="line">  this.history.onReady(cb, errorCb)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onError (errorCb: Function) &#123;</span><br><span class="line">  this.history.onError(errorCb)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">push (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">  this.history.push(location, onComplete, onAbort)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">replace (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">  this.history.replace(location, onComplete, onAbort)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">go (n: number) &#123;</span><br><span class="line">  this.history.go(n)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">back () &#123;</span><br><span class="line">  this.go(-1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">forward () &#123;</span><br><span class="line">  this.go(1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-07-16</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Vue/" title="Vue">Vue </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2019/07/16/Vue-router源码分析1/,DK'S BLOG,Vue-router源码分析1,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/07/23/Vue-router源码分析3/" title="Vue-router源码分析3-视图更新">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/07/15/Axios源码4/" title="Axios源码4-请求的取消">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>