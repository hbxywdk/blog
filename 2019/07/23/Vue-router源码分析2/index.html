<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="hbxywdk,hbxywdk@gmail.com"><title>Vue-router源码分析2-路由模式 · DK'S BLOG</title><meta name="description" content="前文说到，Vue-Router 有三种模式包括 hash、history、abstract，对应 HashHistory、HTML5History、AbstractHistory 三个类。

hash: 使用 URL hash 值来作路由。支持所有浏览器，包括不支持 HTML5 History Ap"><meta name="keywords" content="blog,FE,HTML,CSS,Javascript,Vue,Nuxt"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">DK'S BLOG</a></h3><div class="description"><p>Judge not from appearances.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/DKWang8"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/3136805851"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/hbxywdk"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/de.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Vue-router源码分析2-路由模式</a></h3></div><div class="post-content"><p>前文说到，Vue-Router 有三种模式包括 <code>hash</code>、<code>history</code>、<code>abstract</code>，对应 <code>HashHistory</code>、<code>HTML5History</code>、<code>AbstractHistory</code> 三个类。</p>
<ol>
<li>hash: 使用 URL hash 值来作路由。支持所有浏览器，包括不支持 HTML5 History Api 的浏览器。</li>
<li>history: 依赖 HTML5 History API 和服务器配置。查看 HTML5 History 模式。</li>
<li>abstract: 支持所有 JavaScript 运行环境，如 Node.js 服务器端。如果发现没有浏览器的 API，路由会自动强制进入这个模式。</li>
</ol>
<p>它们提供了一些方法的各自实现供对外暴露的 <code>this.history</code> 调用。<br>通常我们用到的就是 hash 和 history 两种，这里哟也只看 <code>HashHistory</code> 与 <code>HTML5History</code> 两个类。</p>
<h4 id="HashHistory"><a href="#HashHistory" class="headerlink" title="HashHistory"></a>HashHistory</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">export class HashHistory extends History &#123;</span><br><span class="line">  constructor (router: Router, base: ?string, fallback: boolean) &#123;</span><br><span class="line">    super(router, base)</span><br><span class="line">    // check history fallback deeplinking</span><br><span class="line">    if (fallback &amp;&amp; checkFallback(this.base)) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line">    ensureSlash()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 延迟到 app 装载完毕，以免过早的触发 hashchange事件，</span><br><span class="line">  // 此方法会在 newRouter 时会被调用</span><br><span class="line">  setupListeners () &#123;</span><br><span class="line">    const router = this.router</span><br><span class="line">    const expectScroll = router.options.scrollBehavior // 滚动行为函数</span><br><span class="line">    const supportsScroll = supportsPushState &amp;&amp; expectScroll</span><br><span class="line"></span><br><span class="line">    if (supportsScroll) &#123;</span><br><span class="line">      setupScroll()</span><br><span class="line">    &#125;</span><br><span class="line">    // 开启监听</span><br><span class="line">    window.addEventListener(supportsPushState ? &apos;popstate&apos; : &apos;hashchange&apos;, () =&gt; &#123;</span><br><span class="line">      const current = this.current</span><br><span class="line">      if (!ensureSlash()) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      // 先调用 transitionTo 之后处理 scroll 与修改 hash</span><br><span class="line">      this.transitionTo(getHash(), route =&gt; &#123;</span><br><span class="line">        if (supportsScroll) &#123;</span><br><span class="line">          handleScroll(this.router, route, current, true)</span><br><span class="line">        &#125;</span><br><span class="line">        if (!supportsPushState) &#123;</span><br><span class="line">          replaceHash(route.fullPath)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  push (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    const &#123; current: fromRoute &#125; = this</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      pushHash(route.fullPath)</span><br><span class="line">      handleScroll(this.router, route, fromRoute, false)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  replace (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    const &#123; current: fromRoute &#125; = this</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      replaceHash(route.fullPath)</span><br><span class="line">      handleScroll(this.router, route, fromRoute, false)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  go (n: number) &#123;</span><br><span class="line">    window.history.go(n)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ensureURL (push?: boolean) &#123;</span><br><span class="line">    const current = this.current.fullPath</span><br><span class="line">    if (getHash() !== current) &#123;</span><br><span class="line">      push ? pushHash(current) : replaceHash(current)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getCurrentLocation () &#123;</span><br><span class="line">    return getHash()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HTML5History"><a href="#HTML5History" class="headerlink" title="HTML5History"></a>HTML5History</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">export class HTML5History extends History &#123;</span><br><span class="line">  constructor (router: Router, base: ?string) &#123;</span><br><span class="line">    super(router, base)</span><br><span class="line"></span><br><span class="line">    const expectScroll = router.options.scrollBehavior</span><br><span class="line">    const supportsScroll = supportsPushState &amp;&amp; expectScroll</span><br><span class="line"></span><br><span class="line">    if (supportsScroll) &#123;</span><br><span class="line">      setupScroll()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const initLocation = getLocation(this.base)</span><br><span class="line">    window.addEventListener(&apos;popstate&apos;, e =&gt; &#123;</span><br><span class="line">      const current = this.current</span><br><span class="line"></span><br><span class="line">      // Avoiding first `popstate` event dispatched in some browsers but first</span><br><span class="line">      // history route not updated since async guard at the same time.</span><br><span class="line">      const location = getLocation(this.base)</span><br><span class="line">      if (this.current === START &amp;&amp; location === initLocation) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">        if (supportsScroll) &#123;</span><br><span class="line">          handleScroll(router, route, current, true)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  go (n: number) &#123;</span><br><span class="line">    window.history.go(n)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  push (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    const &#123; current: fromRoute &#125; = this</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      pushState(cleanPath(this.base + route.fullPath))</span><br><span class="line">      handleScroll(this.router, route, fromRoute, false)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  replace (location: RawLocation, onComplete?: Function, onAbort?: Function) &#123;</span><br><span class="line">    const &#123; current: fromRoute &#125; = this</span><br><span class="line">    this.transitionTo(location, route =&gt; &#123;</span><br><span class="line">      replaceState(cleanPath(this.base + route.fullPath))</span><br><span class="line">      handleScroll(this.router, route, fromRoute, false)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;, onAbort)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ensureURL (push?: boolean) &#123;</span><br><span class="line">    if (getLocation(this.base) !== this.current.fullPath) &#123;</span><br><span class="line">      const current = cleanPath(this.base + this.current.fullPath)</span><br><span class="line">      push ? pushState(current) : replaceState(current)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getCurrentLocation (): string &#123;</span><br><span class="line">    return getLocation(this.base)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HashHistory 监听的是 hashchange 事件，HashHistory 监听的是 popstate 事件。<br>HashHistory 与 HTML5History 提供了各自的 go、push、replace 等方法，并且他俩都继承自 History 类，它位于 src/history/base.js，它有这样几个主要的方法：</p>
<h4 id="transitionTo"><a href="#transitionTo" class="headerlink" title="transitionTo"></a>transitionTo</h4><p>调用路由过渡，他会调用 confirmTransition 方法确认路由的过渡。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">transitionTo (</span><br><span class="line">  location: RawLocation,</span><br><span class="line">  onComplete?: Function,</span><br><span class="line">  onAbort?: Function</span><br><span class="line">) &#123;</span><br><span class="line">  const route = this.router.match(location, this.current)</span><br><span class="line">  // 确认路由的过渡</span><br><span class="line">  this.confirmTransition(</span><br><span class="line">    route,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      this.updateRoute(route)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">      this.ensureURL()</span><br><span class="line"></span><br><span class="line">      // fire ready cbs once // ready 回调只触发一次</span><br><span class="line">      if (!this.ready) &#123;</span><br><span class="line">        this.ready = true</span><br><span class="line">        this.readyCbs.forEach(cb =&gt; &#123;</span><br><span class="line">          cb(route)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    err =&gt; &#123;</span><br><span class="line">      if (onAbort) &#123;</span><br><span class="line">        onAbort(err)</span><br><span class="line">      &#125;</span><br><span class="line">      if (err &amp;&amp; !this.ready) &#123;</span><br><span class="line">        this.ready = true</span><br><span class="line">        this.readyErrorCbs.forEach(cb =&gt; &#123;</span><br><span class="line">          cb(err)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="confirmTransition"><a href="#confirmTransition" class="headerlink" title="confirmTransition"></a>confirmTransition</h4><p>确认路由的过渡。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">// 确认过渡</span><br><span class="line">confirmTransition (route: Route, onComplete: Function, onAbort?: Function) &#123;</span><br><span class="line">  const current = this.current</span><br><span class="line">  const abort = err =&gt; &#123;</span><br><span class="line">    // 当用户使用前进后退按钮时，我们不想抛出错误。我们只想在调用 push/replace 时抛出。这是它不包含在 isError 中的原因</span><br><span class="line">    if (!isExtendedError(NavigationDuplicated, err) &amp;&amp; isError(err)) &#123;</span><br><span class="line">      if (this.errorCbs.length) &#123;</span><br><span class="line">        this.errorCbs.forEach(cb =&gt; &#123;</span><br><span class="line">          cb(err)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        warn(false, &apos;uncaught error during route navigation:&apos;)</span><br><span class="line">        console.error(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    onAbort &amp;&amp; onAbort(err)</span><br><span class="line">  &#125;</span><br><span class="line">  if (</span><br><span class="line">    isSameRoute(route, current) &amp;&amp;</span><br><span class="line">    // in the case the route map has been dynamically appended to</span><br><span class="line">    route.matched.length === current.matched.length</span><br><span class="line">  ) &#123;</span><br><span class="line">    this.ensureURL()</span><br><span class="line">    return abort(new NavigationDuplicated(route))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // updated, deactivated, activated 生命周期钩子函数，deactivated 是当前路由的，其他两个是下一个路由的</span><br><span class="line">  const &#123; updated, deactivated, activated &#125; = resolveQueue(</span><br><span class="line">    this.current.matched, // 当前路由</span><br><span class="line">    route.matched // 目标路由</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">  // 执行队列</span><br><span class="line">  const queue: Array&lt;?NavigationGuard&gt; = [].concat(</span><br><span class="line">    // 组件内的 leave 导航(即 deactivated 钩子)</span><br><span class="line">    extractLeaveGuards(deactivated),</span><br><span class="line">    // 全局的(VueRouter) before 钩子</span><br><span class="line">    this.router.beforeHooks,</span><br><span class="line">    // 组件内的 updated 钩子</span><br><span class="line">    extractUpdateHooks(updated),</span><br><span class="line">    // in-config enter guards</span><br><span class="line">    // 配置的进入钩子 activated</span><br><span class="line">    activated.map(m =&gt; m.beforeEnter),</span><br><span class="line">    // 处理异步组件，然后触发 activated 钩子</span><br><span class="line">    resolveAsyncComponents(activated)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  this.pending = route</span><br><span class="line"></span><br><span class="line">  // 该迭代器后面会依次迭代 queue</span><br><span class="line">  const iterator = (hook: NavigationGuard, next) =&gt; &#123;</span><br><span class="line">    if (this.pending !== route) &#123;</span><br><span class="line">      return abort()</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">      hook(route, current, (to: any) =&gt; &#123;</span><br><span class="line">        if (to === false || isError(to)) &#123;</span><br><span class="line">          // next(false) -&gt; abort navigation, ensure current URL</span><br><span class="line">          this.ensureURL(true)</span><br><span class="line">          abort(to)</span><br><span class="line">        &#125; else if (</span><br><span class="line">          typeof to === &apos;string&apos; ||</span><br><span class="line">          (typeof to === &apos;object&apos; &amp;&amp;</span><br><span class="line">            (typeof to.path === &apos;string&apos; || typeof to.name === &apos;string&apos;))</span><br><span class="line">        ) &#123;</span><br><span class="line">          // next(&apos;/&apos;) or next(&#123; path: &apos;/&apos; &#125;) -&gt; redirect</span><br><span class="line">          abort()</span><br><span class="line">          if (typeof to === &apos;object&apos; &amp;&amp; to.replace) &#123;</span><br><span class="line">            this.replace(to)</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            this.push(to)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          // confirm transition and pass on the value</span><br><span class="line">          next(to)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      abort(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 运行队列</span><br><span class="line">  runQueue(queue, iterator, () =&gt; &#123;</span><br><span class="line">    const postEnterCbs = []</span><br><span class="line">    const isValid = () =&gt; this.current === route</span><br><span class="line">    // wait until async components are resolved before</span><br><span class="line">    // extracting in-component enter guards</span><br><span class="line">    // 等异步组件执行完成再提取组件内钩子，使用 runQueue 再次迭代</span><br><span class="line">    const enterGuards = extractEnterGuards(activated, postEnterCbs, isValid)</span><br><span class="line">    const queue = enterGuards.concat(this.router.resolveHooks)</span><br><span class="line">    runQueue(queue, iterator, () =&gt; &#123;</span><br><span class="line">      if (this.pending !== route) &#123;</span><br><span class="line">        return abort()</span><br><span class="line">      &#125;</span><br><span class="line">      this.pending = null</span><br><span class="line">      onComplete(route)</span><br><span class="line">      if (this.router.app) &#123;</span><br><span class="line">        this.router.app.$nextTick(() =&gt; &#123;</span><br><span class="line">          postEnterCbs.forEach(cb =&gt; &#123;</span><br><span class="line">            cb()</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>取出当前组件的 deactivated 生命周期函数，目标路由的 updated, activated 生命周期函数。<br>将它们与全局钩子函数组合成一个名为 queue 的队列。又定义了一个名为 iterator 的迭代器。<br>调用 runQueue 方法，使用 iterator 来迭代执行 queue。runQueue 执行完之后再对异步加载的组件执行一此 runQueue。<br>最后调用 updateRoute 更新路由：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 更新路由</span><br><span class="line">updateRoute (route: Route) &#123;</span><br><span class="line">  const prev = this.current</span><br><span class="line">  this.current = route</span><br><span class="line">  this.cb &amp;&amp; this.cb(route)</span><br><span class="line">  this.router.afterHooks.forEach(hook =&gt; &#123;</span><br><span class="line">    hook &amp;&amp; hook(route, prev)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-07-23</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Vue/" title="Vue">Vue </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2019/07/23/Vue-router源码分析2/,DK'S BLOG,Vue-router源码分析2-路由模式,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/07/26/Vue-router源码分析4/" title="Vue-router源码分析4">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/07/23/Vue-router源码分析3/" title="Vue-router源码分析3-视图更新">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>